# P2På”èª¿ãƒ©ã‚¤ãƒ–ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æ©Ÿèƒ½ é–‹ç™ºãƒ—ãƒ©ãƒ³

**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: è¨ˆç”»æ®µéšï¼ˆæœªç€æ‰‹ï¼‰
**å„ªå…ˆåº¦**: ä¸­ï¼ˆElectronç‰ˆã‚¢ãƒ—ãƒªå¾Œã«å®Ÿè£…æ¨å¥¨ï¼‰
**ä½œæˆæ—¥**: 2025-10-10
**æœ€çµ‚æ›´æ–°**: 2025-10-10

---

## ğŸ“‹ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦

### èƒŒæ™¯
VS Code Live Shareã‚„Open Collaboration toolsã¯ä»¥ä¸‹ã®å•é¡Œã‚’æŠ±ãˆã¦ã„ã‚‹ï¼š
- âŒ æ¥ç¶šãŒä¸å®‰å®šï¼ˆé »ç¹ã«åˆ‡æ–­ã•ã‚Œã‚‹ï¼‰
- âŒ ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãŒé«˜ã„ï¼ˆç·¨é›†ãŒé…å»¶ã™ã‚‹ï¼‰
- âŒ è¤‡é›‘ãªè¨­å®šãŒå¿…è¦ï¼ˆèªè¨¼ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®šï¼‰
- âŒ OrbitScoreå›ºæœ‰ã®æ©Ÿèƒ½ï¼ˆã‚¨ãƒ³ã‚¸ãƒ³çŠ¶æ…‹åŒæœŸã€ã‚³ãƒ¼ãƒ‰å®Ÿè¡ŒåŒæœŸï¼‰ã«éå¯¾å¿œ

### ç›®æ¨™
**ã€Œã‚²ãƒ¼ãƒ ã®ãƒãƒ«ãƒãƒ—ãƒ¬ã‚¤ã®ã‚ˆã†ã«ç°¡å˜ã§å®‰å®šã—ãŸå”èª¿ãƒ©ã‚¤ãƒ–ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç’°å¢ƒã€**

- âœ… ãƒ›ã‚¹ãƒˆãŒéƒ¨å±‹ã‚’ä½œæˆã€ä»²é–“ã‚’æ‹›å¾…ï¼ˆP2Pæ¥ç¶šï¼‰
- âœ… ãƒ›ã‚¹ãƒˆãŒè½ã¡ã¦ã‚‚ä»–ã®äººã«ãƒ›ã‚¹ãƒˆãŒå¼•ãç¶™ãŒã‚Œã‚‹ï¼ˆãƒ›ã‚¹ãƒˆãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
- âœ… ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ã‚³ãƒ¼ãƒ‰ç·¨é›†ãƒ»å®Ÿè¡Œã‚’å…±æœ‰
- âœ… å„è‡ªã®SuperColliderã§éŸ³ã‚’é³´ã‚‰ã™ï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é…å»¶ã®å½±éŸ¿ã‚’å—ã‘ãªã„ï¼‰
- âœ… å®‰å®šã—ãŸæ¥ç¶šï¼ˆè‡ªå‹•å†æ¥ç¶šã€ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚µãƒ¼ãƒãƒ¼ï¼‰
- âœ… **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒ£ãƒƒãƒˆ**ï¼ˆãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸äº¤æ›ï¼‰
- âœ… **ã‚³ãƒ¼ãƒ‰ã‚³ãƒ¡ãƒ³ãƒˆæ©Ÿèƒ½**ï¼ˆè¡Œã‚’é¸æŠã—ã¦ã‚³ãƒ¡ãƒ³ãƒˆ â†’ ãƒãƒ£ãƒƒãƒˆã«è¡¨ç¤º â†’ ã‚¯ãƒªãƒƒã‚¯ã§ãã®è¡Œã«ã‚¸ãƒ£ãƒ³ãƒ—ï¼‰

### ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹

#### 1. æ•™è‚²ãƒ»ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ§ãƒƒãƒ—
- è¬›å¸«ãŒãƒ›ã‚¹ãƒˆã€ç”Ÿå¾’5-10äººãŒå‚åŠ 
- è¬›å¸«ãŒã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã â†’ å…¨å“¡ã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åæ˜ 
- ç”Ÿå¾’ã‚‚ç·¨é›†å¯èƒ½ï¼ˆãƒãƒ³ã‚ºã‚ªãƒ³ï¼‰
- è¬›å¸«ãŒé€”ä¸­é€€å‡ºã—ã¦ã‚‚ã€ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆãŒãƒ›ã‚¹ãƒˆã‚’å¼•ãç¶™ãç¶™ç¶š

#### 2. å”èª¿ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
- ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ3-5äººãŒåŒæ™‚å‚åŠ 
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§éŸ³æ¥½ã‚’å…±åŒåˆ¶ä½œ
- èª°ã‹ãŒæ¥ç¶šãƒˆãƒ©ãƒ–ãƒ«ã§ã‚‚ã€ä»–ã®ãƒ¡ãƒ³ãƒãƒ¼ã¯æ¼”å¥ç¶™ç¶š

#### 3. ãƒªãƒ¢ãƒ¼ãƒˆãƒšã‚¢ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°
- é–‹ç™ºè€…2äººã§æ–°æ©Ÿèƒ½ã‚’å®Ÿè£…
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»ç·¨é›†
- ã©ã¡ã‚‰ã‹ãŒè½ã¡ã¦ã‚‚ä½œæ¥­ç¶™ç¶š

---

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ

### P2Pæ¥ç¶šãƒ¢ãƒ‡ãƒ«ï¼ˆWebRTC + ã‚·ã‚°ãƒŠãƒªãƒ³ã‚°ã‚µãƒ¼ãƒãƒ¼ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Signaling Server                        â”‚
â”‚         (åˆæœŸæ¥ç¶šãƒ»ãƒ›ã‚¹ãƒˆç™ºè¦‹ã®ã¿ä½¿ç”¨)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                            â”‚
             â”‚ (æ¥ç¶šç¢ºç«‹å¾Œã¯P2P)          â”‚
             â”‚                            â”‚
        â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
        â”‚ Host    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ Peer 1  â”‚
        â”‚ (Alice) â”‚  WebRTC P2P      â”‚ (Bob)   â”‚
        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
             â”‚                            â”‚
             â”‚                            â”‚
             â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ Peer 2 â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚(Charlie)â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ãƒ›ã‚¹ãƒˆãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 1: é€šå¸¸æ™‚                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Host (Alice) â—„â”€â”€â”€â–º Peer 1 (Bob) â—„â”€â”€â”€â–º Peer 2 (Charlie)  â”‚
â”‚  [Primary]           [Backup]           [Member]         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 2: AliceãŒåˆ‡æ–­ â†’ BobãŒè‡ªå‹•çš„ã«Hostã«æ˜‡æ ¼           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Host (Bob) â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º Peer 2 (Charlie)        â”‚
â”‚  [Primary]                         [Backup]              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 3: AliceãŒå†æ¥ç¶š â†’ Peerã¨ã—ã¦å‚åŠ                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Host (Bob) â—„â”€â”€â”€â–º Peer 1 (Alice) â—„â”€â”€â”€â–º Peer 2 (Charlie)  â”‚
â”‚  [Primary]         [Member]             [Backup]         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ãƒ›ã‚¹ãƒˆé¸å‡ºã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 
1. **èµ·å‹•é †**: æœ€åˆã«éƒ¨å±‹ã‚’ä½œã£ãŸäººãŒãƒ›ã‚¹ãƒˆ
2. **BackupæŒ‡å®š**: ãƒ›ã‚¹ãƒˆãŒæ¬¡ã®ãƒ›ã‚¹ãƒˆå€™è£œã‚’æŒ‡å®šå¯èƒ½
3. **è‡ªå‹•æ˜‡æ ¼**: ãƒ›ã‚¹ãƒˆåˆ‡æ–­æ™‚ã€BackupãŒè‡ªå‹•çš„ã«ãƒ›ã‚¹ãƒˆã«æ˜‡æ ¼
4. **BackupãŒã„ãªã„å ´åˆ**: æ¥ç¶šæ™‚é–“ãŒæœ€ã‚‚é•·ã„PeerãŒæ˜‡æ ¼

---

## ğŸ“ å®Ÿè£…ã‚¿ã‚¹ã‚¯è©³ç´°

### Phase 1: åŸºç›¤å®Ÿè£…ï¼ˆæ¨å®š: 1é€±é–“ï¼‰

#### 1.1 ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
**ä½œæˆç‰©**: `packages/vscode-extension-collab/` ã¾ãŸã¯ `packages/electron-app-collab/`

**ã©ã¡ã‚‰ã§å®Ÿè£…ã™ã‚‹ã‹**:
- **VS Code Extensionç‰ˆ**: é–‹ç™ºç’°å¢ƒå‘ã‘ã€ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—å®Ÿè£…ã«æœ€é©
- **Electron Appçµ±åˆç‰ˆ**: ã‚¨ãƒ³ãƒ‰ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã€æœ€çµ‚è£½å“

**æ¨å¥¨**: VS Code Extensionç‰ˆã§å…ˆè¡Œå®Ÿè£… â†’ å‹•ä½œç¢ºèª â†’ Electronç‰ˆã«ç§»æ¤

**ä¾å­˜é–¢ä¿‚**:
```json
{
  "dependencies": {
    "simple-peer": "^9.11.1",        // WebRTC P2Pæ¥ç¶š
    "socket.io-client": "^4.5.0",   // ã‚·ã‚°ãƒŠãƒªãƒ³ã‚°ã‚µãƒ¼ãƒãƒ¼æ¥ç¶š
    "yjs": "^13.6.0",                // CRDTï¼ˆè¡çªè§£æ±ºï¼‰
    "y-webrtc": "^10.2.5",           // Yjs WebRTC Provider
    "uuid": "^9.0.0",                // ã‚»ãƒƒã‚·ãƒ§ãƒ³IDç”Ÿæˆ
    "eventemitter3": "^5.0.0"        // ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†
  }
}
```

#### 1.2 ã‚·ã‚°ãƒŠãƒªãƒ³ã‚°ã‚µãƒ¼ãƒãƒ¼æ§‹ç¯‰
**ç›®çš„**: P2Pæ¥ç¶šã®åˆæœŸç¢ºç«‹ï¼ˆICEå€™è£œäº¤æ›ã€SDPäº¤æ›ï¼‰

**æŠ€è¡“**: Socket.IO (Node.js)

**å®Ÿè£…**: `packages/collab-signaling-server/`

```typescript
// server.ts
import { Server } from 'socket.io';
import express from 'express';

const app = express();
const server = app.listen(3000);
const io = new Server(server, {
  cors: { origin: '*' }
});

interface Room {
  id: string;
  hostId: string;
  backupId: string | null;
  members: Set<string>;
}

const rooms = new Map<string, Room>();

io.on('connection', (socket) => {
  console.log(`[Connected] ${socket.id}`);

  // éƒ¨å±‹ä½œæˆ
  socket.on('create-room', (roomId: string) => {
    rooms.set(roomId, {
      id: roomId,
      hostId: socket.id,
      backupId: null,
      members: new Set([socket.id])
    });
    socket.join(roomId);
    socket.emit('room-created', { roomId, role: 'host' });
    console.log(`[Room Created] ${roomId} by ${socket.id}`);
  });

  // éƒ¨å±‹å‚åŠ 
  socket.on('join-room', (roomId: string) => {
    const room = rooms.get(roomId);
    if (!room) {
      socket.emit('error', 'Room not found');
      return;
    }

    room.members.add(socket.id);
    socket.join(roomId);

    // æ—¢å­˜ãƒ¡ãƒ³ãƒãƒ¼ã«ã‚·ã‚°ãƒŠãƒ«
    socket.to(roomId).emit('peer-joined', {
      peerId: socket.id,
      role: room.backupId === socket.id ? 'backup' : 'member'
    });

    // æ–°è¦å‚åŠ è€…ã«æ—¢å­˜ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆé€ä¿¡
    const memberList = Array.from(room.members).map(id => ({
      id,
      role: id === room.hostId ? 'host' : id === room.backupId ? 'backup' : 'member'
    }));
    socket.emit('room-joined', {
      roomId,
      role: room.backupId === socket.id ? 'backup' : 'member',
      members: memberList
    });

    console.log(`[Room Joined] ${socket.id} â†’ ${roomId}`);
  });

  // WebRTC ã‚·ã‚°ãƒŠãƒªãƒ³ã‚°
  socket.on('signal', ({ to, signal }) => {
    io.to(to).emit('signal', {
      from: socket.id,
      signal
    });
  });

  // BackupæŒ‡å®š
  socket.on('set-backup', ({ roomId, backupId }) => {
    const room = rooms.get(roomId);
    if (room && socket.id === room.hostId) {
      room.backupId = backupId;
      io.to(roomId).emit('backup-updated', { backupId });
      console.log(`[Backup Set] ${roomId}: ${backupId}`);
    }
  });

  // ãƒ›ã‚¹ãƒˆãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  socket.on('disconnect', () => {
    console.log(`[Disconnected] ${socket.id}`);

    // åˆ‡æ–­ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ›ã‚¹ãƒˆã®å ´åˆ
    rooms.forEach((room, roomId) => {
      if (room.hostId === socket.id) {
        room.members.delete(socket.id);

        if (room.members.size === 0) {
          // å…¨å“¡é€€å‡º â†’ éƒ¨å±‹å‰Šé™¤
          rooms.delete(roomId);
          console.log(`[Room Closed] ${roomId}`);
        } else {
          // Backupã‚’æ–°ãƒ›ã‚¹ãƒˆã«æ˜‡æ ¼
          const newHostId = room.backupId || Array.from(room.members)[0];
          room.hostId = newHostId;
          room.backupId = null;

          io.to(roomId).emit('host-migrated', {
            newHostId,
            reason: 'previous-host-disconnected'
          });

          console.log(`[Host Migrated] ${roomId}: ${socket.id} â†’ ${newHostId}`);
        }
      } else {
        // é€šå¸¸ãƒ¡ãƒ³ãƒãƒ¼ã®åˆ‡æ–­
        room.members.delete(socket.id);
        io.to(roomId).emit('peer-left', { peerId: socket.id });
      }
    });
  });
});

console.log('ğŸš€ Signaling server started on http://localhost:3000');
```

**ãƒ‡ãƒ—ãƒ­ã‚¤**:
- é–‹ç™ºç’°å¢ƒ: ãƒ­ãƒ¼ã‚«ãƒ«èµ·å‹• (`npm run signaling-server`)
- æœ¬ç•ªç’°å¢ƒ: Heroku, Railway, Renderç­‰ã®ç„¡æ–™PaaSã§å…¬é–‹

#### 1.3 P2Pæ¥ç¶šãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼
**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/p2p/connection-manager.ts`

```typescript
import SimplePeer from 'simple-peer';
import { io, Socket } from 'socket.io-client';
import EventEmitter from 'eventemitter3';

export type Role = 'host' | 'backup' | 'member';

export interface Peer {
  id: string;
  role: Role;
  connection: SimplePeer.Instance;
}

export class ConnectionManager extends EventEmitter {
  private signalingSocket: Socket;
  private peers = new Map<string, Peer>();
  private myId: string = '';
  private myRole: Role = 'member';
  private roomId: string = '';

  constructor(private signalingServerUrl: string) {
    super();
    this.signalingSocket = io(signalingServerUrl);
    this.setupSignalingHandlers();
  }

  // éƒ¨å±‹ä½œæˆï¼ˆãƒ›ã‚¹ãƒˆã¨ã—ã¦ï¼‰
  createRoom(): string {
    this.roomId = this.generateRoomId();
    this.myRole = 'host';
    this.signalingSocket.emit('create-room', this.roomId);
    return this.roomId;
  }

  // éƒ¨å±‹å‚åŠ ï¼ˆãƒ¡ãƒ³ãƒãƒ¼ã¨ã—ã¦ï¼‰
  joinRoom(roomId: string): void {
    this.roomId = roomId;
    this.signalingSocket.emit('join-room', roomId);
  }

  // BackupæŒ‡å®šï¼ˆãƒ›ã‚¹ãƒˆã®ã¿ï¼‰
  setBackup(peerId: string): void {
    if (this.myRole !== 'host') {
      throw new Error('Only host can set backup');
    }
    this.signalingSocket.emit('set-backup', {
      roomId: this.roomId,
      backupId: peerId
    });
  }

  // å…¨Peerã«ãƒ‡ãƒ¼ã‚¿é€ä¿¡
  broadcast(data: any): void {
    this.peers.forEach(peer => {
      if (peer.connection.connected) {
        peer.connection.send(JSON.stringify(data));
      }
    });
  }

  // ç‰¹å®šPeerã«ãƒ‡ãƒ¼ã‚¿é€ä¿¡
  sendTo(peerId: string, data: any): void {
    const peer = this.peers.get(peerId);
    if (peer && peer.connection.connected) {
      peer.connection.send(JSON.stringify(data));
    }
  }

  private setupSignalingHandlers(): void {
    this.signalingSocket.on('connect', () => {
      this.myId = this.signalingSocket.id!;
      this.emit('connected', { myId: this.myId });
    });

    this.signalingSocket.on('room-created', ({ roomId, role }) => {
      this.myRole = role;
      this.emit('room-created', { roomId, role });
    });

    this.signalingSocket.on('room-joined', ({ roomId, role, members }) => {
      this.myRole = role;
      this.emit('room-joined', { roomId, role });

      // æ—¢å­˜ãƒ¡ãƒ³ãƒãƒ¼ã¨P2Pæ¥ç¶šç¢ºç«‹
      members.forEach(({ id, role }) => {
        if (id !== this.myId) {
          this.connectToPeer(id, role, true);
        }
      });
    });

    this.signalingSocket.on('peer-joined', ({ peerId, role }) => {
      this.connectToPeer(peerId, role, false);
    });

    this.signalingSocket.on('peer-left', ({ peerId }) => {
      this.disconnectPeer(peerId);
    });

    this.signalingSocket.on('signal', ({ from, signal }) => {
      const peer = this.peers.get(from);
      if (peer) {
        peer.connection.signal(signal);
      }
    });

    this.signalingSocket.on('backup-updated', ({ backupId }) => {
      if (backupId === this.myId) {
        this.myRole = 'backup';
      }
      this.emit('backup-updated', { backupId });
    });

    this.signalingSocket.on('host-migrated', ({ newHostId, reason }) => {
      if (newHostId === this.myId) {
        this.myRole = 'host';
        this.emit('promoted-to-host', { reason });
      }
      this.emit('host-migrated', { newHostId, reason });
    });
  }

  private connectToPeer(peerId: string, role: Role, initiator: boolean): void {
    const peer = new SimplePeer({ initiator, trickle: false });

    peer.on('signal', (signal) => {
      this.signalingSocket.emit('signal', { to: peerId, signal });
    });

    peer.on('connect', () => {
      console.log(`[P2P Connected] ${peerId}`);
      this.emit('peer-connected', { peerId, role });
    });

    peer.on('data', (data) => {
      const message = JSON.parse(data.toString());
      this.emit('data', { peerId, data: message });
    });

    peer.on('close', () => {
      console.log(`[P2P Closed] ${peerId}`);
      this.disconnectPeer(peerId);
    });

    peer.on('error', (err) => {
      console.error(`[P2P Error] ${peerId}:`, err);
      this.emit('peer-error', { peerId, error: err });
    });

    this.peers.set(peerId, { id: peerId, role, connection: peer });
  }

  private disconnectPeer(peerId: string): void {
    const peer = this.peers.get(peerId);
    if (peer) {
      peer.connection.destroy();
      this.peers.delete(peerId);
      this.emit('peer-disconnected', { peerId });
    }
  }

  private generateRoomId(): string {
    return Math.random().toString(36).substring(2, 8).toUpperCase();
  }

  disconnect(): void {
    this.peers.forEach(peer => peer.connection.destroy());
    this.peers.clear();
    this.signalingSocket.disconnect();
  }
}
```

**æˆæœç‰©**: P2Pæ¥ç¶šãŒç¢ºç«‹ã§ãã‚‹åŸºç›¤

---

### Phase 2: ãƒ‡ãƒ¼ã‚¿åŒæœŸå®Ÿè£…ï¼ˆæ¨å®š: 1é€±é–“ï¼‰

#### 2.1 CRDTçµ±åˆï¼ˆYjsï¼‰
**ç›®çš„**: è¤‡æ•°äººãŒåŒæ™‚ç·¨é›†ã—ã¦ã‚‚ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã—ãªã„

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/sync/crdt-manager.ts`

```typescript
import * as Y from 'yjs';
import { WebrtcProvider } from 'y-webrtc';

export class CRDTManager {
  private ydoc: Y.Doc;
  private provider: WebrtcProvider;
  private ytext: Y.Text;

  constructor(roomId: string, signalingServer: string) {
    this.ydoc = new Y.Doc();
    this.ytext = this.ydoc.getText('orbitscore-code');

    // WebRTC Providerï¼ˆY.jsã®æ¨™æº–WebRTCçµ±åˆï¼‰
    this.provider = new WebrtcProvider(roomId, this.ydoc, {
      signaling: [signalingServer]
    });
  }

  // ãƒ†ã‚­ã‚¹ãƒˆå–å¾—
  getText(): string {
    return this.ytext.toString();
  }

  // ãƒ†ã‚­ã‚¹ãƒˆæŒ¿å…¥
  insert(index: number, text: string): void {
    this.ytext.insert(index, text);
  }

  // ãƒ†ã‚­ã‚¹ãƒˆå‰Šé™¤
  delete(index: number, length: number): void {
    this.ytext.delete(index, length);
  }

  // å¤‰æ›´ç›£è¦–
  observe(callback: (event: Y.YTextEvent) => void): void {
    this.ytext.observe(callback);
  }

  // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®åŒæœŸï¼ˆAwarenessï¼‰
  setAwareness(state: { name: string; color: string; cursor: number }): void {
    this.provider.awareness.setLocalState(state);
  }

  getAwareness(): Map<number, any> {
    return this.provider.awareness.getStates();
  }

  destroy(): void {
    this.provider.destroy();
    this.ydoc.destroy();
  }
}
```

#### 2.2 ã‚¨ãƒ‡ã‚£ã‚¿çµ±åˆ
**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/sync/editor-sync.ts`

**VS Codeç‰ˆ**:
```typescript
import * as vscode from 'vscode';
import { CRDTManager } from './crdt-manager';

export class EditorSync {
  private crdt: CRDTManager;
  private editor: vscode.TextEditor;
  private isRemoteChange = false;

  constructor(editor: vscode.TextEditor, roomId: string, signalingServer: string) {
    this.editor = editor;
    this.crdt = new CRDTManager(roomId, signalingServer);
    this.setupSync();
  }

  private setupSync(): void {
    // ãƒ­ãƒ¼ã‚«ãƒ«ç·¨é›† â†’ CRDT
    vscode.workspace.onDidChangeTextDocument((event) => {
      if (event.document !== this.editor.document || this.isRemoteChange) {
        return;
      }

      event.contentChanges.forEach((change) => {
        this.crdt.delete(change.rangeOffset, change.rangeLength);
        if (change.text) {
          this.crdt.insert(change.rangeOffset, change.text);
        }
      });
    });

    // CRDT â†’ ãƒ­ãƒ¼ã‚«ãƒ«ç·¨é›†
    this.crdt.observe((event) => {
      this.isRemoteChange = true;

      const edit = new vscode.WorkspaceEdit();
      event.changes.forEach((change) => {
        if (change.action === 'insert') {
          const pos = this.editor.document.positionAt(change.index);
          edit.insert(this.editor.document.uri, pos, change.text);
        } else if (change.action === 'delete') {
          const start = this.editor.document.positionAt(change.index);
          const end = this.editor.document.positionAt(change.index + change.length);
          edit.delete(this.editor.document.uri, new vscode.Range(start, end));
        }
      });

      vscode.workspace.applyEdit(edit).then(() => {
        this.isRemoteChange = false;
      });
    });

    // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®åŒæœŸ
    vscode.window.onDidChangeTextEditorSelection((event) => {
      if (event.textEditor === this.editor) {
        const cursor = this.editor.document.offsetAt(event.selections[0].active);
        this.crdt.setAwareness({
          name: 'User', // TODO: ãƒ¦ãƒ¼ã‚¶ãƒ¼åå–å¾—
          color: this.generateColor(),
          cursor
        });
      }
    });
  }

  private generateColor(): string {
    const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8'];
    return colors[Math.floor(Math.random() * colors.length)];
  }

  destroy(): void {
    this.crdt.destroy();
  }
}
```

**Monaco Editorç‰ˆï¼ˆElectron Appç”¨ï¼‰**:
```typescript
import * as monaco from 'monaco-editor';
import { CRDTManager } from './crdt-manager';

export class MonacoEditorSync {
  private crdt: CRDTManager;
  private editor: monaco.editor.IStandaloneCodeEditor;
  private isRemoteChange = false;

  constructor(
    editor: monaco.editor.IStandaloneCodeEditor,
    roomId: string,
    signalingServer: string
  ) {
    this.editor = editor;
    this.crdt = new CRDTManager(roomId, signalingServer);
    this.setupSync();
  }

  private setupSync(): void {
    const model = this.editor.getModel()!;

    // ãƒ­ãƒ¼ã‚«ãƒ«ç·¨é›† â†’ CRDT
    model.onDidChangeContent((event) => {
      if (this.isRemoteChange) return;

      event.changes.forEach((change) => {
        this.crdt.delete(change.rangeOffset, change.rangeLength);
        if (change.text) {
          this.crdt.insert(change.rangeOffset, change.text);
        }
      });
    });

    // CRDT â†’ ãƒ­ãƒ¼ã‚«ãƒ«ç·¨é›†
    this.crdt.observe((event) => {
      this.isRemoteChange = true;

      const edits: monaco.editor.IIdentifiedSingleEditOperation[] = [];

      event.changes.forEach((change) => {
        if (change.action === 'insert') {
          const pos = model.getPositionAt(change.index);
          edits.push({
            range: new monaco.Range(pos.lineNumber, pos.column, pos.lineNumber, pos.column),
            text: change.text,
            forceMoveMarkers: true
          });
        } else if (change.action === 'delete') {
          const start = model.getPositionAt(change.index);
          const end = model.getPositionAt(change.index + change.length);
          edits.push({
            range: new monaco.Range(
              start.lineNumber,
              start.column,
              end.lineNumber,
              end.column
            ),
            text: '',
            forceMoveMarkers: true
          });
        }
      });

      model.applyEdits(edits);
      this.isRemoteChange = false;
    });

    // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®åŒæœŸ
    this.editor.onDidChangeCursorPosition((event) => {
      const cursor = model.getOffsetAt(event.position);
      this.crdt.setAwareness({
        name: 'User',
        color: this.generateColor(),
        cursor
      });
    });
  }

  private generateColor(): string {
    const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8'];
    return colors[Math.floor(Math.random() * colors.length)];
  }

  destroy(): void {
    this.crdt.destroy();
  }
}
```

#### 2.3 ã‚¨ãƒ³ã‚¸ãƒ³çŠ¶æ…‹åŒæœŸ
**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/sync/engine-state-sync.ts`

```typescript
import { ConnectionManager } from '../p2p/connection-manager';

export interface EngineState {
  tempo: number;
  tick: number;
  beat: number;
  runGroup: string[];
  loopGroup: string[];
  muteGroup: string[];
}

export class EngineStateSync {
  private connectionManager: ConnectionManager;
  private currentState: EngineState;

  constructor(connectionManager: ConnectionManager) {
    this.connectionManager = connectionManager;
    this.currentState = {
      tempo: 120,
      tick: 16,
      beat: 4,
      runGroup: [],
      loopGroup: [],
      muteGroup: []
    };

    this.setupListeners();
  }

  // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¨ãƒ³ã‚¸ãƒ³çŠ¶æ…‹æ›´æ–°æ™‚ã«å‘¼ã³å‡ºã™
  updateState(state: Partial<EngineState>): void {
    this.currentState = { ...this.currentState, ...state };
    this.broadcast();
  }

  private broadcast(): void {
    this.connectionManager.broadcast({
      type: 'engine-state',
      state: this.currentState
    });
  }

  private setupListeners(): void {
    this.connectionManager.on('data', ({ peerId, data }) => {
      if (data.type === 'engine-state') {
        this.handleRemoteStateUpdate(data.state);
      }
    });
  }

  private handleRemoteStateUpdate(state: EngineState): void {
    // ãƒªãƒ¢ãƒ¼ãƒˆçŠ¶æ…‹ã‚’é©ç”¨ï¼ˆãƒãƒ¼ã‚¸ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
    // ãƒ›ã‚¹ãƒˆã®çŠ¶æ…‹ã‚’å„ªå…ˆï¼ˆãƒ›ã‚¹ãƒˆãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ™‚ã¯æ–°ãƒ›ã‚¹ãƒˆã®çŠ¶æ…‹ï¼‰
    this.currentState = state;

    // UIã«åæ˜ ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆç™ºç«ï¼‰
    this.emit('state-updated', state);
  }

  private emit(event: string, data: any): void {
    // TODO: EventEmitterçµ±åˆ
  }
}
```

**æˆæœç‰©**: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ç·¨é›†ãƒ»çŠ¶æ…‹ãŒåŒæœŸã•ã‚Œã‚‹

---

### Phase 3: ã‚³ãƒ¼ãƒ‰å®Ÿè¡ŒåŒæœŸï¼ˆæ¨å®š: 3-5æ—¥ï¼‰

#### 3.1 å®Ÿè¡Œã‚¤ãƒ™ãƒ³ãƒˆåŒæœŸ
**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/sync/execution-sync.ts`

```typescript
import { ConnectionManager } from '../p2p/connection-manager';

export interface ExecutionEvent {
  userId: string;
  userName: string;
  code: string;
  timestamp: number;
  rangeStart: number;
  rangeEnd: number;
}

export class ExecutionSync {
  private connectionManager: ConnectionManager;

  constructor(connectionManager: ConnectionManager) {
    this.connectionManager = connectionManager;
    this.setupListeners();
  }

  // ãƒ­ãƒ¼ã‚«ãƒ«ã§ã‚³ãƒ¼ãƒ‰å®Ÿè¡Œæ™‚ã«å‘¼ã³å‡ºã™
  broadcastExecution(event: ExecutionEvent): void {
    this.connectionManager.broadcast({
      type: 'code-execution',
      event
    });
  }

  private setupListeners(): void {
    this.connectionManager.on('data', ({ peerId, data }) => {
      if (data.type === 'code-execution') {
        this.handleRemoteExecution(data.event);
      }
    });
  }

  private handleRemoteExecution(event: ExecutionEvent): void {
    // ãƒªãƒ¢ãƒ¼ãƒˆå®Ÿè¡Œã‚’å„è‡ªã®ã‚¨ãƒ³ã‚¸ãƒ³ã§å†ç”Ÿ
    // TODO: ã‚¨ãƒ³ã‚¸ãƒ³ã«æ¸¡ã™

    // UIã«ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤º
    this.highlightRemoteExecution(event);
  }

  private highlightRemoteExecution(event: ExecutionEvent): void {
    // ã‚¨ãƒ‡ã‚£ã‚¿ä¸Šã§å®Ÿè¡Œã•ã‚ŒãŸç¯„å›²ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼è‰²ã§ãƒ•ãƒ©ãƒƒã‚·ãƒ¥è¡¨ç¤º
    // TODO: UIå®Ÿè£…
  }
}
```

#### 3.2 éŸ³å£°å‡ºåŠ›ãƒ¢ãƒ¼ãƒ‰ã®è¨­è¨ˆ

**âš ï¸ é‡è¦ãªå•é¡Œ**: è¤‡æ•°äººãŒåŒæ™‚ã«éŸ³ã‚’å‡ºã™ã¨ã€åŒã˜éŸ³ãŒé‡è¤‡ã—ã¦çˆ†éŸ³ã«ãªã‚‹

**è§£æ±ºç­–: 3ã¤ã®éŸ³å£°å‡ºåŠ›ãƒ¢ãƒ¼ãƒ‰**

##### ãƒ¢ãƒ¼ãƒ‰1: **å€‹åˆ¥ãƒ¢ãƒ¼ãƒ‰ï¼ˆIndividual Modeï¼‰** - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ

å„è‡ªãŒç‹¬ç«‹ã—ã¦éŸ³ã‚’å‡ºã™ï¼ˆæ•™è‚²ãƒ»ãƒãƒ³ã‚ºã‚ªãƒ³å‘ã‘ï¼‰

**å‹•ä½œ**:
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼AãŒã‚³ãƒ¼ãƒ‰å®Ÿè¡Œï¼ˆCmd+Enterï¼‰
2. **ãƒ¦ãƒ¼ã‚¶ãƒ¼Aã®SuperColliderã®ã¿**ã§éŸ³ãŒé³´ã‚‹
3. å®Ÿè¡Œã‚¤ãƒ™ãƒ³ãƒˆãŒå…¨å“¡ã«ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆ
4. ãƒ¦ãƒ¼ã‚¶ãƒ¼B, Cã¯**ã‚³ãƒ¼ãƒ‰å¤‰æ›´ã®ã¿å—ä¿¡**ï¼ˆéŸ³ã¯å‡ºã•ãªã„ï¼‰
5. ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¨ãƒ‡ã‚£ã‚¿ä¸Šã§ã€ŒAãŒå®Ÿè¡Œä¸­ã€ã‚’è¦–è¦šçš„ã«ç¢ºèª

**ä½¿ç”¨ä¾‹**:
- ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ§ãƒƒãƒ—ã§å„è‡ªãŒç·´ç¿’
- è¬›å¸«ãŒãƒ‡ãƒ¢ â†’ ç”Ÿå¾’ã¯è´ãã ã‘

##### ãƒ¢ãƒ¼ãƒ‰2: **ãƒ›ã‚¹ãƒˆå°‚ç”¨ãƒ¢ãƒ¼ãƒ‰ï¼ˆHost-Only Modeï¼‰**

ãƒ›ã‚¹ãƒˆã ã‘ãŒéŸ³ã‚’å‡ºã›ã‚‹ï¼ˆãƒ©ã‚¤ãƒ–ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ã‘ï¼‰

**å‹•ä½œ**:
1. ãƒ›ã‚¹ãƒˆã®ã¿ãŒã‚³ãƒ¼ãƒ‰å®Ÿè¡Œå¯èƒ½
2. ä»–ã®ãƒ¡ãƒ³ãƒãƒ¼ã¯é–²è¦§ãƒ»ç·¨é›†ã®ã¿ï¼ˆå®Ÿè¡Œã¯ç„¡åŠ¹åŒ–ï¼‰
3. ãƒ›ã‚¹ãƒˆãŒè½ã¡ãŸå ´åˆ â†’ æ–°ãƒ›ã‚¹ãƒˆã«è‡ªå‹•å¼•ãç¶™ãï¼ˆå¾Œè¿°ï¼‰

**ä½¿ç”¨ä¾‹**:
- ãƒ©ã‚¤ãƒ–ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ï¼ˆãƒ›ã‚¹ãƒˆ = ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ¼ï¼‰
- ãƒªãƒ¢ãƒ¼ãƒˆãƒšã‚¢ãƒ—ãƒ­ï¼ˆãƒ›ã‚¹ãƒˆ = ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ï¼‰

##### ãƒ¢ãƒ¼ãƒ‰3: **å…±æœ‰ãƒ¢ãƒ¼ãƒ‰ï¼ˆShared Modeï¼‰** - ä¸Šç´šè€…å‘ã‘

å…¨å“¡ã®éŸ³ã‚’ãƒŸã‚­ã‚µãƒ¼ã§åˆæˆï¼ˆå”èª¿ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ã‘ï¼‰

**å‹•ä½œ**:
1. å„è‡ªã®SuperColliderãŒç•°ãªã‚‹ãƒˆãƒ©ãƒƒã‚¯ã‚’æ‹…å½“
2. å…¨å“¡ã®éŸ³ãŒãƒŸã‚­ã‚µãƒ¼ã«é€ã‚‰ã‚Œã‚‹
3. ãƒŸã‚­ã‚µãƒ¼ã§åˆæˆ â†’ ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼å‡ºåŠ›

**ä½¿ç”¨ä¾‹**:
- è¤‡æ•°äººã§ã®ãƒ©ã‚¤ãƒ–æ¼”å¥
- å½¹å‰²åˆ†æ‹…ï¼ˆAãŒãƒ‰ãƒ©ãƒ ã€BãŒãƒ™ãƒ¼ã‚¹ã€CãŒãƒ¡ãƒ­ãƒ‡ã‚£ï¼‰

**âš ï¸ æ³¨æ„**: ã“ã®ãƒ¢ãƒ¼ãƒ‰ã¯æ‰‹å‹•è¨­å®šãŒå¿…è¦ï¼ˆå„è‡ªãŒã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’æ§‹æˆï¼‰

##### ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½

```typescript
// src/sync/audio-output-mode.ts
export type AudioOutputMode = 'individual' | 'host-only' | 'shared';

export class AudioOutputManager {
  private mode: AudioOutputMode = 'individual';
  private connectionManager: ConnectionManager;
  private isHost: boolean;

  setMode(mode: AudioOutputMode): void {
    this.mode = mode;
    this.connectionManager.broadcast({
      type: 'audio-mode-changed',
      mode
    });
  }

  shouldExecuteLocally(event: ExecutionEvent): boolean {
    switch (this.mode) {
      case 'individual':
        // è‡ªåˆ†ãŒå®Ÿè¡Œã—ãŸå ´åˆã®ã¿éŸ³ã‚’å‡ºã™
        return event.userId === this.connectionManager.myId;

      case 'host-only':
        // ãƒ›ã‚¹ãƒˆã®å®Ÿè¡Œã®ã¿éŸ³ã‚’å‡ºã™
        return event.userId === this.connectionManager.hostId;

      case 'shared':
        // å…¨å“¡ãŒéŸ³ã‚’å‡ºã™ï¼ˆå„è‡ªãŒç•°ãªã‚‹ãƒˆãƒ©ãƒƒã‚¯ã‚’æ‹…å½“ã™ã‚‹æƒ³å®šï¼‰
        return true;

      default:
        return false;
    }
  }
}
```

**UI**: ãƒ¢ãƒ¼ãƒ‰é¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³
```
Audio Output Mode:
[ Individual â–¼ ]  â† Host-Only / Shared
```

**ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ**: `Individual` ãƒ¢ãƒ¼ãƒ‰ï¼ˆæœ€ã‚‚å®‰å…¨ï¼‰

##### ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ä¿è­·æ©Ÿèƒ½

**å•é¡Œ**: éŸ³ãŒæ€¥ã«å‡ºã‚‹/æ­¢ã¾ã‚‹ã¨ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ãŒç ´æã™ã‚‹å¯èƒ½æ€§

**è§£æ±ºç­–**: ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³/ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ

```typescript
// src/audio/speaker-protection.ts
export class SpeakerProtection {
  private fadeInMs = 50;   // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³æ™‚é–“
  private fadeOutMs = 100; // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆæ™‚é–“

  async fadeIn(engineManager: EngineManager): Promise<void> {
    // SuperColliderã®ãƒã‚¹ã‚¿ãƒ¼ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’0â†’1ã«å¾ã€…ã«ä¸Šã’ã‚‹
    await engineManager.execute(`
      s.volume.volume = 0;
      s.volume.volume = 1.linlin(0, 1, 0, 1, ${this.fadeInMs / 1000});
    `);
  }

  async fadeOut(engineManager: EngineManager): Promise<void> {
    // SuperColliderã®ãƒã‚¹ã‚¿ãƒ¼ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’1â†’0ã«å¾ã€…ã«ä¸‹ã’ã‚‹
    await engineManager.execute(`
      s.volume.volume = 1.linlin(0, 1, 0, 1, ${this.fadeOutMs / 1000});
    `);

    // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆå®Œäº†ã¾ã§å¾…æ©Ÿ
    await new Promise(resolve => setTimeout(resolve, this.fadeOutMs));
  }

  async safeMute(engineManager: EngineManager): Promise<void> {
    await this.fadeOut(engineManager);
    await engineManager.execute('s.freeAll'); // å…¨éŸ³åœæ­¢
  }
}
```

**é©ç”¨ã‚·ãƒ¼ãƒ³**:
- ãƒ›ã‚¹ãƒˆãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ™‚ï¼ˆæ—§ãƒ›ã‚¹ãƒˆã®éŸ³ã‚’ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ â†’ æ–°ãƒ›ã‚¹ãƒˆã®éŸ³ã‚’ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ï¼‰
- ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆæ™‚
- ç·Šæ€¥åœæ­¢æ™‚ï¼ˆPanic Buttonï¼‰

**æˆæœç‰©**: éŸ³å£°å‡ºåŠ›ã®æ’ä»–åˆ¶å¾¡ + ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ä¿è­·

---

### Phase 4: UI/UXå®Ÿè£…ï¼ˆæ¨å®š: 1é€±é–“ï¼‰

#### 4.1 ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†UI

**VS Code Extensionç‰ˆ**: ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒ‘ãƒãƒ«

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸŒ OrbitScore Collaboration     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [â• Create Session]              â”‚
â”‚ [ğŸ”— Join Session]                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Status: Not Connected           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆæ™‚**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸŒ Collaboration Session        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Status: Active (Host)           â”‚
â”‚ Room ID: ABC123                 â”‚
â”‚ [ğŸ“‹ Copy Invite Link]           â”‚
â”‚ [ğŸ›‘ End Session]                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ‘¥ Participants (3)             â”‚
â”‚ â— Alice (You, Host) ğŸ”´         â”‚
â”‚ â— Bob (Backup)     ğŸ”µ          â”‚
â”‚ â— Charlie          ğŸŸ¢          â”‚
â”‚                                 â”‚
â”‚ Right-click for options:        â”‚
â”‚ - Set as Backup                 â”‚
â”‚ - Kick User                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®Ÿè£…** (`src/ui/session-panel.ts`):
```typescript
import * as vscode from 'vscode';
import { ConnectionManager } from '../p2p/connection-manager';

export class SessionPanel {
  private panel: vscode.WebviewPanel;
  private connectionManager: ConnectionManager;

  constructor(context: vscode.ExtensionContext, connectionManager: ConnectionManager) {
    this.connectionManager = connectionManager;

    this.panel = vscode.window.createWebviewPanel(
      'orbitscoreCollab',
      'OrbitScore Collaboration',
      vscode.ViewColumn.Two,
      { enableScripts: true }
    );

    this.panel.webview.html = this.getHtmlContent();
    this.setupMessageHandlers();
  }

  private getHtmlContent(): string {
    return `
      <!DOCTYPE html>
      <html>
      <head>
        <style>
          body { font-family: var(--vscode-font-family); padding: 20px; }
          button { padding: 10px; margin: 5px 0; width: 100%; }
          .participant { padding: 5px; margin: 5px 0; }
          .host { color: #FF6B6B; }
          .backup { color: #4ECDC4; }
          .member { color: #98D8C8; }
        </style>
      </head>
      <body>
        <h2>ğŸŒ OrbitScore Collaboration</h2>
        <button id="create-btn">â• Create Session</button>
        <button id="join-btn">ğŸ”— Join Session</button>

        <div id="session-info" style="display: none;">
          <h3>Status: <span id="status">Connected</span></h3>
          <p>Room ID: <span id="room-id"></span></p>
          <button id="copy-link-btn">ğŸ“‹ Copy Invite Link</button>
          <button id="end-btn">ğŸ›‘ End Session</button>

          <h3>ğŸ‘¥ Participants</h3>
          <div id="participants"></div>
        </div>

        <script>
          const vscode = acquireVsCodeApi();

          document.getElementById('create-btn').addEventListener('click', () => {
            vscode.postMessage({ command: 'create-session' });
          });

          document.getElementById('join-btn').addEventListener('click', () => {
            vscode.postMessage({ command: 'join-session' });
          });

          document.getElementById('copy-link-btn').addEventListener('click', () => {
            const roomId = document.getElementById('room-id').textContent;
            vscode.postMessage({ command: 'copy-link', roomId });
          });

          document.getElementById('end-btn').addEventListener('click', () => {
            vscode.postMessage({ command: 'end-session' });
          });

          window.addEventListener('message', (event) => {
            const message = event.data;
            switch (message.command) {
              case 'session-created':
                document.getElementById('room-id').textContent = message.roomId;
                document.getElementById('session-info').style.display = 'block';
                break;
              case 'update-participants':
                updateParticipants(message.participants);
                break;
            }
          });

          function updateParticipants(participants) {
            const container = document.getElementById('participants');
            container.innerHTML = participants.map(p =>
              \`<div class="participant \${p.role}">â— \${p.name} (\${p.role})</div>\`
            ).join('');
          }
        </script>
      </body>
      </html>
    `;
  }

  private setupMessageHandlers(): void {
    this.panel.webview.onDidReceiveMessage((message) => {
      switch (message.command) {
        case 'create-session':
          this.createSession();
          break;
        case 'join-session':
          this.joinSession();
          break;
        case 'copy-link':
          this.copyInviteLink(message.roomId);
          break;
        case 'end-session':
          this.endSession();
          break;
      }
    });
  }

  private createSession(): void {
    const roomId = this.connectionManager.createRoom();
    this.panel.webview.postMessage({
      command: 'session-created',
      roomId
    });

    vscode.window.showInformationMessage(
      `Session created! Room ID: ${roomId}`,
      'Copy Link'
    ).then((action) => {
      if (action === 'Copy Link') {
        this.copyInviteLink(roomId);
      }
    });
  }

  private async joinSession(): Promise<void> {
    const roomId = await vscode.window.showInputBox({
      prompt: 'Enter Room ID or paste invite link',
      placeHolder: 'ABC123 or orbitscore://join/ABC123'
    });

    if (roomId) {
      const cleanRoomId = roomId.replace(/^orbitscore:\/\/join\//, '');
      this.connectionManager.joinRoom(cleanRoomId);
    }
  }

  private copyInviteLink(roomId: string): void {
    const link = `orbitscore://join/${roomId}`;
    vscode.env.clipboard.writeText(link);
    vscode.window.showInformationMessage('Invite link copied!');
  }

  private endSession(): void {
    this.connectionManager.disconnect();
    this.panel.webview.postMessage({ command: 'session-ended' });
    vscode.window.showInformationMessage('Session ended.');
  }
}
```

#### 4.2 ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ãƒ»é¸æŠç¯„å›²ã®è¡¨ç¤º

**ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’è‰²åˆ†ã‘è¡¨ç¤º**

**VS Codeç‰ˆ**:
```typescript
import * as vscode from 'vscode';
import { CRDTManager } from '../sync/crdt-manager';

export class CursorDecorations {
  private editor: vscode.TextEditor;
  private crdt: CRDTManager;
  private decorationTypes = new Map<number, vscode.TextEditorDecorationType>();

  constructor(editor: vscode.TextEditor, crdt: CRDTManager) {
    this.editor = editor;
    this.crdt = crdt;
    this.setupAwarenessListener();
  }

  private setupAwarenessListener(): void {
    this.crdt.provider.awareness.on('change', () => {
      this.updateCursorDecorations();
    });
  }

  private updateCursorDecorations(): void {
    const states = this.crdt.getAwareness();

    states.forEach((state, clientId) => {
      if (!state.cursor) return;

      const position = this.editor.document.positionAt(state.cursor);
      const range = new vscode.Range(position, position);

      let decorationType = this.decorationTypes.get(clientId);
      if (!decorationType) {
        decorationType = vscode.window.createTextEditorDecorationType({
          borderStyle: 'solid',
          borderWidth: '0 0 0 2px',
          borderColor: state.color,
          after: {
            contentText: ` ${state.name}`,
            color: state.color,
            fontStyle: 'italic'
          }
        });
        this.decorationTypes.set(clientId, decorationType);
      }

      this.editor.setDecorations(decorationType, [range]);
    });
  }

  destroy(): void {
    this.decorationTypes.forEach(decoration => decoration.dispose());
    this.decorationTypes.clear();
  }
}
```

**Monaco Editorç‰ˆ**:
```typescript
import * as monaco from 'monaco-editor';
import { CRDTManager } from '../sync/crdt-manager';

export class MonacoCursorDecorations {
  private editor: monaco.editor.IStandaloneCodeEditor;
  private crdt: CRDTManager;
  private decorations: string[] = [];

  constructor(editor: monaco.editor.IStandaloneCodeEditor, crdt: CRDTManager) {
    this.editor = editor;
    this.crdt = crdt;
    this.setupAwarenessListener();
  }

  private setupAwarenessListener(): void {
    this.crdt.provider.awareness.on('change', () => {
      this.updateCursorDecorations();
    });
  }

  private updateCursorDecorations(): void {
    const model = this.editor.getModel()!;
    const states = this.crdt.getAwareness();

    const newDecorations: monaco.editor.IModelDeltaDecoration[] = [];

    states.forEach((state, clientId) => {
      if (!state.cursor) return;

      const position = model.getPositionAt(state.cursor);

      newDecorations.push({
        range: new monaco.Range(
          position.lineNumber,
          position.column,
          position.lineNumber,
          position.column
        ),
        options: {
          className: 'remote-cursor',
          glyphMarginClassName: 'remote-cursor-glyph',
          beforeContentClassName: 'remote-cursor-label',
          hoverMessage: { value: state.name },
          stickiness: monaco.editor.TrackedRangeStickiness.NeverGrowsWhenTypingAtEdges
        }
      });
    });

    this.decorations = this.editor.deltaDecorations(this.decorations, newDecorations);
  }

  destroy(): void {
    this.editor.deltaDecorations(this.decorations, []);
  }
}
```

**CSS**:
```css
.remote-cursor {
  border-left: 2px solid var(--user-color);
  position: relative;
}

.remote-cursor-label::before {
  content: attr(data-user-name);
  position: absolute;
  top: -20px;
  left: 0;
  background: var(--user-color);
  color: white;
  padding: 2px 5px;
  border-radius: 3px;
  font-size: 10px;
  white-space: nowrap;
}
```

**æˆæœç‰©**: ç¾ã—ã„ã‚³ãƒ©ãƒœãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³UI

---

### Phase 4.5: ãƒãƒ£ãƒƒãƒˆãƒ»ã‚³ãƒ¡ãƒ³ãƒˆæ©Ÿèƒ½ï¼ˆæ¨å®š: 1é€±é–“ï¼‰

#### 4.5.1 ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒ£ãƒƒãƒˆ

**ç›®çš„**: ã‚³ãƒ©ãƒœãƒ¬ãƒ¼ã‚¿ãƒ¼åŒå£«ãŒãƒ†ã‚­ã‚¹ãƒˆã§ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/chat/chat-manager.ts`

```typescript
import { ConnectionManager } from '../p2p/connection-manager';
import EventEmitter from 'eventemitter3';

export interface ChatMessage {
  id: string;
  userId: string;
  userName: string;
  userColor: string;
  text: string;
  timestamp: number;
  type: 'text' | 'code-comment' | 'system';

  // code-commentã®å ´åˆã®ã¿
  codeReference?: {
    lineStart: number;
    lineEnd: number;
    code: string;
    fileName?: string;
  };
}

export class ChatManager extends EventEmitter {
  private connectionManager: ConnectionManager;
  private messages: ChatMessage[] = [];
  private myUserId: string;
  private myUserName: string;
  private myUserColor: string;

  constructor(
    connectionManager: ConnectionManager,
    userId: string,
    userName: string,
    userColor: string
  ) {
    super();
    this.connectionManager = connectionManager;
    this.myUserId = userId;
    this.myUserName = userName;
    this.myUserColor = userColor;
    this.setupListeners();
  }

  // ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
  sendMessage(text: string): void {
    const message: ChatMessage = {
      id: this.generateMessageId(),
      userId: this.myUserId,
      userName: this.myUserName,
      userColor: this.myUserColor,
      text,
      timestamp: Date.now(),
      type: 'text'
    };

    this.addMessage(message);
    this.broadcast(message);
  }

  // ã‚³ãƒ¼ãƒ‰ã‚³ãƒ¡ãƒ³ãƒˆé€ä¿¡
  sendCodeComment(
    text: string,
    lineStart: number,
    lineEnd: number,
    code: string,
    fileName?: string
  ): void {
    const message: ChatMessage = {
      id: this.generateMessageId(),
      userId: this.myUserId,
      userName: this.myUserName,
      userColor: this.myUserColor,
      text,
      timestamp: Date.now(),
      type: 'code-comment',
      codeReference: {
        lineStart,
        lineEnd,
        code,
        fileName
      }
    };

    this.addMessage(message);
    this.broadcast(message);
  }

  // ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ï¼ˆå‚åŠ /é€€å‡ºé€šçŸ¥ï¼‰
  sendSystemMessage(text: string): void {
    const message: ChatMessage = {
      id: this.generateMessageId(),
      userId: 'system',
      userName: 'System',
      userColor: '#999999',
      text,
      timestamp: Date.now(),
      type: 'system'
    };

    this.addMessage(message);
    this.broadcast(message);
  }

  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´å–å¾—
  getMessages(): ChatMessage[] {
    return [...this.messages];
  }

  private broadcast(message: ChatMessage): void {
    this.connectionManager.broadcast({
      type: 'chat-message',
      message
    });
  }

  private setupListeners(): void {
    this.connectionManager.on('data', ({ peerId, data }) => {
      if (data.type === 'chat-message') {
        this.handleRemoteMessage(data.message);
      }
    });

    // æ–°è¦å‚åŠ è€…ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´é€ä¿¡
    this.connectionManager.on('peer-connected', ({ peerId }) => {
      this.connectionManager.sendTo(peerId, {
        type: 'chat-history',
        messages: this.messages
      });
    });

    // å‚åŠ è€…ã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´ã‚’å—ä¿¡
    this.connectionManager.on('data', ({ peerId, data }) => {
      if (data.type === 'chat-history') {
        // æ—¢å­˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ãƒãƒ¼ã‚¸ï¼ˆé‡è¤‡æ’é™¤ï¼‰
        this.mergeMessages(data.messages);
      }
    });
  }

  private handleRemoteMessage(message: ChatMessage): void {
    this.addMessage(message);
  }

  private addMessage(message: ChatMessage): void {
    this.messages.push(message);
    this.emit('message', message);

    // æœ€å¤§1000ä»¶ã¾ã§ä¿æŒï¼ˆå¤ã„ã‚‚ã®ã‹ã‚‰å‰Šé™¤ï¼‰
    if (this.messages.length > 1000) {
      this.messages.shift();
    }
  }

  private mergeMessages(newMessages: ChatMessage[]): void {
    const existingIds = new Set(this.messages.map(m => m.id));

    newMessages.forEach(msg => {
      if (!existingIds.has(msg.id)) {
        this.messages.push(msg);
      }
    });

    // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã§ã‚½ãƒ¼ãƒˆ
    this.messages.sort((a, b) => a.timestamp - b.timestamp);

    this.emit('history-updated', this.messages);
  }

  private generateMessageId(): string {
    return `${this.myUserId}-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`;
  }

  destroy(): void {
    this.messages = [];
    this.removeAllListeners();
  }
}
```

#### 4.5.2 ãƒãƒ£ãƒƒãƒˆUI

**VS Code Extensionç‰ˆ**: ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒ‘ãƒãƒ«ã«ãƒãƒ£ãƒƒãƒˆã‚’è¿½åŠ 

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸŒ Collaboration Session        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Status: Active (Host)           â”‚
â”‚ Room ID: ABC123                 â”‚
â”‚ [ğŸ“‹ Copy Invite Link]           â”‚
â”‚ [ğŸ›‘ End Session]                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ‘¥ Participants (3)             â”‚
â”‚ â— Alice (You, Host) ğŸ”´         â”‚
â”‚ â— Bob (Backup)     ğŸ”µ          â”‚
â”‚ â— Charlie          ğŸŸ¢          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ’¬ Chat                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [Alice] 10:30                   â”‚
â”‚ Hey, let's try this pattern!    â”‚
â”‚                                 â”‚
â”‚ [Bob] 10:31 â†’ Line 15-18        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚ â”‚ kick.play(               â”‚    â”‚
â”‚ â”‚   (0)(1)(2)(3)           â”‚    â”‚
â”‚ â”‚ )                        â”‚    â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚ This sounds great!              â”‚
â”‚                                 â”‚
â”‚ [System] 10:32                  â”‚
â”‚ Charlie joined the session      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [Type message...]         [Send]â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®Ÿè£…** (`src/ui/chat-panel.ts`):

```typescript
import * as vscode from 'vscode';
import { ChatManager, ChatMessage } from '../chat/chat-manager';

export class ChatPanel {
  private panel: vscode.WebviewPanel;
  private chatManager: ChatManager;

  constructor(
    context: vscode.ExtensionContext,
    chatManager: ChatManager
  ) {
    this.chatManager = chatManager;

    this.panel = vscode.window.createWebviewPanel(
      'orbitscoreChat',
      'OrbitScore Chat',
      vscode.ViewColumn.Two,
      {
        enableScripts: true,
        retainContextWhenHidden: true
      }
    );

    this.panel.webview.html = this.getHtmlContent();
    this.setupMessageHandlers();
    this.setupChatListeners();
  }

  private getHtmlContent(): string {
    return `
      <!DOCTYPE html>
      <html>
      <head>
        <style>
          body {
            font-family: var(--vscode-font-family);
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
          }

          #messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
          }

          .message {
            margin-bottom: 15px;
            padding: 8px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.05);
          }

          .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 12px;
            opacity: 0.7;
          }

          .message-author {
            font-weight: bold;
          }

          .message-text {
            margin-top: 5px;
            white-space: pre-wrap;
          }

          .code-reference {
            margin-top: 8px;
            padding: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-left: 3px solid var(--user-color);
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            cursor: pointer;
            position: relative;
          }

          .code-reference:hover {
            background: rgba(0, 0, 0, 0.5);
          }

          .code-reference::before {
            content: 'â†’ Line ' attr(data-line-start) '-' attr(data-line-end);
            position: absolute;
            top: -18px;
            left: 8px;
            font-size: 10px;
            color: var(--user-color);
          }

          .code-reference code {
            white-space: pre;
            display: block;
          }

          .system-message {
            text-align: center;
            font-style: italic;
            opacity: 0.5;
            font-size: 12px;
          }

          #input-container {
            display: flex;
            padding: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
          }

          #message-input {
            flex: 1;
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--vscode-editor-foreground);
            border-radius: 4px;
          }

          #send-button {
            margin-left: 10px;
            padding: 8px 16px;
            background: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
            border: none;
            border-radius: 4px;
            cursor: pointer;
          }

          #send-button:hover {
            background: var(--vscode-button-hoverBackground);
          }
        </style>
      </head>
      <body>
        <div id="messages"></div>

        <div id="input-container">
          <input
            type="text"
            id="message-input"
            placeholder="Type message... (Ctrl+Enter to send)"
          />
          <button id="send-button">Send</button>
        </div>

        <script>
          const vscode = acquireVsCodeApi();
          const messagesContainer = document.getElementById('messages');
          const messageInput = document.getElementById('message-input');
          const sendButton = document.getElementById('send-button');

          // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
          function sendMessage() {
            const text = messageInput.value.trim();
            if (text) {
              vscode.postMessage({ command: 'send-message', text });
              messageInput.value = '';
            }
          }

          sendButton.addEventListener('click', sendMessage);

          messageInput.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'Enter') {
              sendMessage();
            }
          });

          // ã‚³ãƒ¼ãƒ‰å‚ç…§ã‚¯ãƒªãƒƒã‚¯ â†’ ã‚¨ãƒ‡ã‚£ã‚¿ã«ã‚¸ãƒ£ãƒ³ãƒ—
          messagesContainer.addEventListener('click', (e) => {
            const codeRef = e.target.closest('.code-reference');
            if (codeRef) {
              const messageId = codeRef.dataset.messageId;
              const lineStart = parseInt(codeRef.dataset.lineStart);
              const lineEnd = parseInt(codeRef.dataset.lineEnd);

              vscode.postMessage({
                command: 'jump-to-code',
                messageId,
                lineStart,
                lineEnd
              });
            }
          });

          // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡
          window.addEventListener('message', (event) => {
            const message = event.data;

            switch (message.command) {
              case 'add-message':
                addMessage(message.message);
                break;
              case 'load-history':
                messagesContainer.innerHTML = '';
                message.messages.forEach(msg => addMessage(msg));
                break;
            }
          });

          function addMessage(msg) {
            const div = document.createElement('div');
            div.className = 'message';

            if (msg.type === 'system') {
              div.classList.add('system-message');
              div.textContent = msg.text;
            } else {
              const time = new Date(msg.timestamp).toLocaleTimeString('ja-JP', {
                hour: '2-digit',
                minute: '2-digit'
              });

              let html = \`
                <div class="message-header">
                  <span class="message-author" style="color: \${msg.userColor}">
                    [\${msg.userName}]
                  </span>
                  <span class="message-time">\${time}</span>
                </div>
              \`;

              if (msg.codeReference) {
                html += \`
                  <div
                    class="code-reference"
                    style="--user-color: \${msg.userColor}"
                    data-message-id="\${msg.id}"
                    data-line-start="\${msg.codeReference.lineStart}"
                    data-line-end="\${msg.codeReference.lineEnd}"
                  >
                    <code>\${escapeHtml(msg.codeReference.code)}</code>
                  </div>
                \`;
              }

              html += \`<div class="message-text">\${escapeHtml(msg.text)}</div>\`;

              div.innerHTML = html;
            }

            messagesContainer.appendChild(div);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
          }

          function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
          }
        </script>
      </body>
      </html>
    `;
  }

  private setupMessageHandlers(): void {
    this.panel.webview.onDidReceiveMessage((message) => {
      switch (message.command) {
        case 'send-message':
          this.chatManager.sendMessage(message.text);
          break;

        case 'jump-to-code':
          this.jumpToCode(message.lineStart, message.lineEnd);
          break;
      }
    });
  }

  private setupChatListeners(): void {
    // æ–°è¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡
    this.chatManager.on('message', (message: ChatMessage) => {
      this.panel.webview.postMessage({
        command: 'add-message',
        message
      });
    });

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´æ›´æ–°
    this.chatManager.on('history-updated', (messages: ChatMessage[]) => {
      this.panel.webview.postMessage({
        command: 'load-history',
        messages
      });
    });
  }

  private jumpToCode(lineStart: number, lineEnd: number): void {
    const editor = vscode.window.activeTextEditor;
    if (!editor) return;

    // è¡Œç•ªå·ã¯0-indexedã«å¤‰æ›
    const range = new vscode.Range(
      new vscode.Position(lineStart - 1, 0),
      new vscode.Position(lineEnd - 1, Number.MAX_VALUE)
    );

    editor.selection = new vscode.Selection(range.start, range.end);
    editor.revealRange(range, vscode.TextEditorRevealType.InCenter);

    // ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    const decoration = vscode.window.createTextEditorDecorationType({
      backgroundColor: 'rgba(100, 150, 255, 0.3)',
      isWholeLine: true
    });

    editor.setDecorations(decoration, [range]);

    setTimeout(() => {
      decoration.dispose();
    }, 2000);
  }
}
```

#### 4.5.3 ã‚³ãƒ¼ãƒ‰ã‚³ãƒ¡ãƒ³ãƒˆæ©Ÿèƒ½

**VS Code Extensionçµ±åˆ**:

```typescript
// extension.ts ã«è¿½åŠ 
import { ChatManager } from './chat/chat-manager';
import { ChatPanel } from './ui/chat-panel';

let chatManager: ChatManager;
let chatPanel: ChatPanel;

// ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆæ™‚
chatManager = new ChatManager(
  connectionManager,
  connectionManager.myId,
  'User', // TODO: ãƒ¦ãƒ¼ã‚¶ãƒ¼åå…¥åŠ›UI
  '#FF6B6B' // TODO: ãƒ©ãƒ³ãƒ€ãƒ è‰²ç”Ÿæˆ
);

chatPanel = new ChatPanel(context, chatManager);

// ã‚³ãƒ¼ãƒ‰ã‚³ãƒ¡ãƒ³ãƒˆã‚³ãƒãƒ³ãƒ‰ç™»éŒ²
context.subscriptions.push(
  vscode.commands.registerCommand('orbitscore.commentOnSelection', async () => {
    const editor = vscode.window.activeTextEditor;
    if (!editor) return;

    const selection = editor.selection;
    if (selection.isEmpty) {
      vscode.window.showWarningMessage('Please select code to comment on');
      return;
    }

    // ã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ›
    const comment = await vscode.window.showInputBox({
      prompt: 'Enter your comment on the selected code',
      placeHolder: 'This pattern is interesting!'
    });

    if (!comment) return;

    // é¸æŠç¯„å›²ã®æƒ…å ±å–å¾—
    const lineStart = selection.start.line + 1; // 1-indexed
    const lineEnd = selection.end.line + 1;
    const code = editor.document.getText(selection);
    const fileName = editor.document.fileName;

    // ãƒãƒ£ãƒƒãƒˆã«é€ä¿¡
    chatManager.sendCodeComment(comment, lineStart, lineEnd, code, fileName);

    vscode.window.showInformationMessage('Comment sent to chat!');
  })
);

// ã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒ‰è¿½åŠ ï¼ˆpackage.jsonï¼‰
{
  "command": "orbitscore.commentOnSelection",
  "key": "cmd+shift+c",
  "when": "editorTextFocus && editorLangId == orbitscore"
}
```

**ä½¿ã„æ–¹**:
1. ã‚³ãƒ¼ãƒ‰ã‚’é¸æŠ
2. **Cmd+Shift+C** (macOS) / **Ctrl+Shift+C** (Windows/Linux)
3. ã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ›
4. ãƒãƒ£ãƒƒãƒˆã«è¡¨ç¤ºã•ã‚Œã‚‹
5. ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒãƒ£ãƒƒãƒˆå†…ã®ã‚³ãƒ¼ãƒ‰å‚ç…§ã‚’ã‚¯ãƒªãƒƒã‚¯ â†’ ãã®è¡Œã«ã‚¸ãƒ£ãƒ³ãƒ—

#### 4.5.4 Monaco Editorç‰ˆï¼ˆElectron Appç”¨ï¼‰

```typescript
import * as monaco from 'monaco-editor';
import { ChatManager } from '../chat/chat-manager';

export class MonacoChatIntegration {
  private editor: monaco.editor.IStandaloneCodeEditor;
  private chatManager: ChatManager;

  constructor(
    editor: monaco.editor.IStandaloneCodeEditor,
    chatManager: ChatManager
  ) {
    this.editor = editor;
    this.chatManager = chatManager;
    this.setupContextMenu();
  }

  private setupContextMenu(): void {
    // å³ã‚¯ãƒªãƒƒã‚¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«ã€ŒComment on Selectionã€è¿½åŠ 
    this.editor.addAction({
      id: 'orbitscore.comment-on-selection',
      label: 'Comment on Selection',
      contextMenuGroupId: 'orbitscore',
      contextMenuOrder: 1,
      keybindings: [
        monaco.KeyMod.CtrlCmd | monaco.KeyMod.Shift | monaco.KeyCode.KeyC
      ],
      run: (editor) => {
        this.handleCommentOnSelection();
      }
    });
  }

  private async handleCommentOnSelection(): Promise<void> {
    const selection = this.editor.getSelection();
    if (!selection || selection.isEmpty()) {
      alert('Please select code to comment on');
      return;
    }

    const model = this.editor.getModel();
    if (!model) return;

    // ã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ›ï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¡¨ç¤ºï¼‰
    const comment = prompt('Enter your comment on the selected code:');
    if (!comment) return;

    // é¸æŠç¯„å›²ã®æƒ…å ±å–å¾—
    const lineStart = selection.startLineNumber;
    const lineEnd = selection.endLineNumber;
    const code = model.getValueInRange(selection);

    // ãƒãƒ£ãƒƒãƒˆã«é€ä¿¡
    this.chatManager.sendCodeComment(comment, lineStart, lineEnd, code);

    console.log('Comment sent to chat!');
  }

  jumpToCode(lineStart: number, lineEnd: number): void {
    const range = new monaco.Range(lineStart, 1, lineEnd, Number.MAX_VALUE);

    this.editor.setSelection(range);
    this.editor.revealRangeInCenter(range, monaco.editor.ScrollType.Smooth);

    // ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    const decorations = this.editor.deltaDecorations([], [
      {
        range: range,
        options: {
          isWholeLine: true,
          className: 'jump-highlight',
          inlineClassName: 'jump-highlight-inline'
        }
      }
    ]);

    setTimeout(() => {
      this.editor.deltaDecorations(decorations, []);
    }, 2000);
  }
}
```

**CSS** (Electron Appç”¨):
```css
.jump-highlight {
  background-color: rgba(100, 150, 255, 0.3);
  animation: pulse 0.5s ease-in-out 3;
}

.jump-highlight-inline {
  background-color: rgba(100, 150, 255, 0.2);
}

@keyframes pulse {
  0%, 100% {
    opacity: 1;
  }
  50% {
    opacity: 0.5;
  }
}
```

**æˆæœç‰©**: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒ£ãƒƒãƒˆ + ã‚³ãƒ¼ãƒ‰å‚ç…§æ©Ÿèƒ½

---

### Phase 5: ãƒ›ã‚¹ãƒˆãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆæ¨å®š: 3-5æ—¥ï¼‰

#### 5.1 ãƒ›ã‚¹ãƒˆåˆ‡æ–­æ¤œå‡º + ç¢ºèªãƒ•ãƒ­ãƒ¼

**âš ï¸ é‡è¦**: ãƒ›ã‚¹ãƒˆãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯æ…é‡ã«è¡Œã†å¿…è¦ãŒã‚ã‚‹
- éŸ³ãŒæ€¥ã«åˆ‡ã‚Œã‚‹/é³´ã‚Šå‡ºã™ã¨ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ãŒç ´æã™ã‚‹å¯èƒ½æ€§
- æ„å›³ã—ãªã„ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ãƒ›ã‚¹ãƒˆãŒå¤‰ã‚ã‚‹ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒå°ç„¡ã—ã«ãªã‚‹

**è§£æ±ºç­–: 3æ®µéšã®å®‰å…¨ãªå¼•ãç¶™ããƒ•ãƒ­ãƒ¼**

##### ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ›ã‚¹ãƒˆåˆ‡æ–­æ¤œå‡º

```typescript
// src/p2p/host-migration.ts
import { ConnectionManager, Role } from './connection-manager';

export class HostMigration {
  private connectionManager: ConnectionManager;
  private heartbeatInterval: NodeJS.Timeout | null = null;
  private hostTimeout: NodeJS.Timeout | null = null;
  private migrationState: 'idle' | 'confirming' | 'migrating' = 'idle';

  constructor(connectionManager: ConnectionManager) {
    this.connectionManager = connectionManager;
    this.setupHeartbeat();
    this.setupHostMigrationHandlers();
  }

  private setupHeartbeat(): void {
    // ãƒ›ã‚¹ãƒˆã¯å®šæœŸçš„ã«ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆé€ä¿¡ï¼ˆ5ç§’ã”ã¨ï¼‰
    if (this.connectionManager.myRole === 'host') {
      this.heartbeatInterval = setInterval(() => {
        this.connectionManager.broadcast({
          type: 'heartbeat',
          timestamp: Date.now()
        });
      }, 5000);
    }
  }

  private setupHostMigrationHandlers(): void {
    this.connectionManager.on('data', ({ peerId, data }) => {
      if (data.type === 'heartbeat') {
        this.resetHostTimeout();
      }
    });
  }

  private resetHostTimeout(): void {
    if (this.hostTimeout) {
      clearTimeout(this.hostTimeout);
    }

    // ãƒ›ã‚¹ãƒˆã‹ã‚‰ã®ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆãŒ15ç§’é€”çµ¶ãˆãŸã‚‰åˆ‡æ–­ã¨åˆ¤æ–­
    this.hostTimeout = setTimeout(() => {
      this.handleHostDisconnected();
    }, 15000);
  }

  private handleHostDisconnected(): void {
    console.warn('[Host Disconnected] Starting migration confirmation...');

    // ã‚¹ãƒ†ãƒƒãƒ—2ã¸: ç¢ºèªãƒ•ã‚§ãƒ¼ã‚ºé–‹å§‹
    this.startMigrationConfirmation();
  }

  destroy(): void {
    if (this.heartbeatInterval) {
      clearInterval(this.heartbeatInterval);
    }
    if (this.hostTimeout) {
      clearTimeout(this.hostTimeout);
    }
  }
}
```

##### ã‚¹ãƒ†ãƒƒãƒ—2: å¼•ãç¶™ãç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°

**å‹•ä½œãƒ•ãƒ­ãƒ¼**:
1. ãƒ›ã‚¹ãƒˆåˆ‡æ–­æ¤œå‡º
2. **å…¨ãƒ¡ãƒ³ãƒãƒ¼ã«ãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤º**: "Host disconnected. Would you like to take over as the new host?"
3. æœ€åˆã«ã€ŒYesã€ã‚’æŠ¼ã—ãŸäººãŒæ–°ãƒ›ã‚¹ãƒˆã«æ˜‡æ ¼
4. ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆ30ç§’ï¼‰ã¾ã§ã«èª°ã‚‚å¿œç­”ã—ãªã„å ´åˆ â†’ ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†

```typescript
// ã‚¹ãƒ†ãƒƒãƒ—2ã®å®Ÿè£…
private startMigrationConfirmation(): void {
  this.migrationState = 'confirming';

  // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’å…¨å“¡ã«é€ä¿¡
  this.connectionManager.broadcast({
    type: 'host-migration-confirmation-request',
    timeout: 30000, // 30ç§’
    timestamp: Date.now()
  });

  // ãƒ­ãƒ¼ã‚«ãƒ«ã«ã‚‚ãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤º
  this.showMigrationConfirmationDialog();

  // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
  setTimeout(() => {
    if (this.migrationState === 'confirming') {
      // èª°ã‚‚å¿œç­”ã—ãªã‹ã£ãŸ â†’ ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†
      this.handleMigrationTimeout();
    }
  }, 30000);
}

private async showMigrationConfirmationDialog(): Promise<void> {
  // VS Codeç‰ˆ
  const response = await vscode.window.showWarningMessage(
    'âš ï¸ Host disconnected. Would you like to take over as the new host?',
    { modal: true },
    'Yes, Take Over',
    'No, Let Others'
  );

  if (response === 'Yes, Take Over') {
    this.acceptHostRole();
  }

  // Electronç‰ˆï¼ˆåŒæ§˜ã®ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’Modalã§è¡¨ç¤ºï¼‰
}

private acceptHostRole(): void {
  if (this.migrationState !== 'confirming') {
    // æ—¢ã«ä»–ã®äººãŒãƒ›ã‚¹ãƒˆã«ãªã£ãŸ
    vscode.window.showInformationMessage('Another user has already taken over as host.');
    return;
  }

  // ä»–ã®ãƒ¡ãƒ³ãƒãƒ¼ã«é€šçŸ¥
  this.connectionManager.broadcast({
    type: 'host-migration-accepted',
    newHostId: this.connectionManager.myId,
    timestamp: Date.now()
  });

  // ã‚¹ãƒ†ãƒƒãƒ—3ã¸: å¼•ãç¶™ãå‡¦ç†é–‹å§‹
  this.startMigration();
}
```

**UIä¾‹ï¼ˆVS Codeï¼‰**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âš ï¸  Host Disconnected                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ The current host has disconnected.       â”‚
â”‚ Would you like to take over as the new   â”‚
â”‚ host?                                    â”‚
â”‚                                          â”‚
â”‚ âš ï¸ Warning: Taking over will make you    â”‚
â”‚ responsible for audio output.            â”‚
â”‚                                          â”‚
â”‚ Timeout: 25 seconds remaining            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [Yes, Take Over]  [No, Let Others]       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

##### ã‚¹ãƒ†ãƒƒãƒ—3: å®‰å…¨ãªå¼•ãç¶™ãå‡¦ç†

**å‹•ä½œ**:
1. **æ—§ãƒ›ã‚¹ãƒˆã®éŸ³ã‚’ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ**ï¼ˆã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ä¿è­·ï¼‰
2. **æ–°ãƒ›ã‚¹ãƒˆã«çŠ¶æ…‹åŒæœŸ**ï¼ˆã‚¨ãƒ³ã‚¸ãƒ³çŠ¶æ…‹ã€CRDTï¼‰
3. **æ–°ãƒ›ã‚¹ãƒˆã®éŸ³ã‚’ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³**
4. **å…¨å“¡ã«é€šçŸ¥**: "Alice is now the host"

```typescript
private async startMigration(): Promise<void> {
  this.migrationState = 'migrating';

  // 1. æ—§ãƒ›ã‚¹ãƒˆã®éŸ³ã‚’ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆï¼ˆã‚‚ã—ã¾ã é³´ã£ã¦ã„ã‚Œã°ï¼‰
  await this.speakerProtection.fadeOut(this.engineManager);

  // 2. æ–°ãƒ›ã‚¹ãƒˆã¨ã—ã¦ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆé–‹å§‹
  this.setupHeartbeat();
  this.connectionManager.myRole = 'host';

  // 3. çŠ¶æ…‹åŒæœŸç¢ºèªï¼ˆCRDTçµŒç”±ã§æ—¢ã«åŒæœŸæ¸ˆã¿ã®ã¯ãšï¼‰
  const currentState = await this.syncState();

  // 4. æ–°ãƒ›ã‚¹ãƒˆã®éŸ³ã‚’ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³
  await this.speakerProtection.fadeIn(this.engineManager);

  // 5. å…¨å“¡ã«é€šçŸ¥
  this.connectionManager.broadcast({
    type: 'host-migration-completed',
    newHostId: this.connectionManager.myId,
    timestamp: Date.now()
  });

  this.migrationState = 'idle';

  vscode.window.showInformationMessage('âœ… You are now the host!');
  this.chatManager.sendSystemMessage('Host migrated successfully.');
}

private handleMigrationTimeout(): void {
  this.migrationState = 'idle';

  // èª°ã‚‚å¼•ãç¶™ãŒãªã‹ã£ãŸ â†’ ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†
  vscode.window.showErrorMessage(
    'âŒ No one accepted the host role. Session will be closed.'
  );

  this.connectionManager.disconnect();
}
```

**UIé€šçŸ¥ä¾‹**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… Host Migration Completed              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Alice is now the host.                   â”‚
â”‚ Session continues normally.              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ãƒãƒ£ãƒƒãƒˆé€šçŸ¥ä¾‹**:
```
[System] 10:35
âš ï¸ Bob (Host) disconnected

[System] 10:35
Alice accepted the host role

[System] 10:35
âœ… Host migration completed
```

##### ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

**ã‚±ãƒ¼ã‚¹1: è¤‡æ•°äººãŒåŒæ™‚ã«ã€ŒYesã€ã‚’æŠ¼ã—ãŸ**
- **è§£æ±º**: æœ€åˆã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ãŸäººãŒå„ªå…ˆï¼ˆã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã§åˆ¤å®šï¼‰
- ä»–ã®äººã«ã¯ã€ŒAnother user has already taken overã€ã‚’è¡¨ç¤º

**ã‚±ãƒ¼ã‚¹2: æ–°ãƒ›ã‚¹ãƒˆã‚‚ç›´å¾Œã«åˆ‡æ–­ã—ãŸ**
- **è§£æ±º**: å†åº¦ç¢ºèªãƒ•ãƒ­ãƒ¼ã‚’é–‹å§‹ï¼ˆæœ€å¤§3å›ã¾ã§ï¼‰
- 3å›å¤±æ•—ã—ãŸã‚‰ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†

**ã‚±ãƒ¼ã‚¹3: éŸ³ãŒãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆä¸­ã«æ–°ã—ã„ã‚³ãƒ¼ãƒ‰ãŒå®Ÿè¡Œã•ã‚ŒãŸ**
- **è§£æ±º**: ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆå®Œäº†ã¾ã§å®Ÿè¡Œã‚’ã‚­ãƒ¥ãƒ¼ã«æºœã‚ã‚‹ â†’ ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³å¾Œã«å®Ÿè¡Œ

**æˆæœç‰©**: å®‰å…¨ã§ç¢ºèªãƒ•ãƒ­ãƒ¼ä»˜ãã®ãƒ›ã‚¹ãƒˆãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

#### 5.2 çŠ¶æ…‹å¼•ãç¶™ã

**å•é¡Œ**: ãƒ›ã‚¹ãƒˆãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ™‚ã€æ–°ãƒ›ã‚¹ãƒˆã¯æ—§ãƒ›ã‚¹ãƒˆã®çŠ¶æ…‹ã‚’å¼•ãç¶™ãå¿…è¦ãŒã‚ã‚‹

**è§£æ±ºç­–**: CRDTï¼ˆY.jsï¼‰ãŒè‡ªå‹•çš„ã«çŠ¶æ…‹ã‚’åŒæœŸã—ã¦ã„ã‚‹ãŸã‚ã€è¿½åŠ å®Ÿè£…ä¸è¦
- ã‚¨ãƒ‡ã‚£ã‚¿å†…å®¹: Y.jsãŒå…¨Peerã§åŒæœŸæ¸ˆã¿
- ã‚¨ãƒ³ã‚¸ãƒ³çŠ¶æ…‹: æœ€å¾Œã«ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆã•ã‚ŒãŸçŠ¶æ…‹ã‚’ä¿æŒ
- ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®: Awareness APIã§åŒæœŸæ¸ˆã¿

**è¿½åŠ å‡¦ç†**:
```typescript
// æ–°ãƒ›ã‚¹ãƒˆæ˜‡æ ¼æ™‚ã«å…¨Peerã«çŠ¶æ…‹ç¢ºèªãƒªã‚¯ã‚¨ã‚¹ãƒˆ
this.connectionManager.broadcast({
  type: 'request-state-sync',
  timestamp: Date.now()
});

// å„Peerã¯æœ€æ–°çŠ¶æ…‹ã‚’è¿”ä¿¡
this.connectionManager.on('data', ({ peerId, data }) => {
  if (data.type === 'request-state-sync') {
    this.connectionManager.sendTo(peerId, {
      type: 'state-sync-response',
      editorContent: this.crdt.getText(),
      engineState: this.engineState
    });
  }
});
```

**æˆæœç‰©**: ãƒ›ã‚¹ãƒˆãŒè½ã¡ã¦ã‚‚ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¶™ç¶š

---

### Phase 6: å®‰å®šæ€§ãƒ»ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼ˆæ¨å®š: 3-5æ—¥ï¼‰

#### 6.1 è‡ªå‹•å†æ¥ç¶š

```typescript
export class AutoReconnect {
  private connectionManager: ConnectionManager;
  private roomId: string;
  private reconnectAttempts = 0;
  private maxReconnectAttempts = 5;

  constructor(connectionManager: ConnectionManager, roomId: string) {
    this.connectionManager = connectionManager;
    this.roomId = roomId;
    this.setupDisconnectHandler();
  }

  private setupDisconnectHandler(): void {
    this.connectionManager.on('disconnected', () => {
      this.attemptReconnect();
    });
  }

  private async attemptReconnect(): Promise<void> {
    if (this.reconnectAttempts >= this.maxReconnectAttempts) {
      console.error('[Reconnect Failed] Max attempts reached');
      // TODO: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥
      return;
    }

    this.reconnectAttempts++;
    const delay = Math.min(1000 * Math.pow(2, this.reconnectAttempts), 10000);

    console.log(`[Reconnecting] Attempt ${this.reconnectAttempts} in ${delay}ms...`);

    await new Promise(resolve => setTimeout(resolve, delay));

    try {
      await this.connectionManager.joinRoom(this.roomId);
      this.reconnectAttempts = 0; // ãƒªã‚»ãƒƒãƒˆ
      console.log('[Reconnected] Successfully');
    } catch (err) {
      console.error('[Reconnect Error]', err);
      this.attemptReconnect(); // ãƒªãƒˆãƒ©ã‚¤
    }
  }
}
```

#### 6.2 ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚µãƒ¼ãƒãƒ¼

**ã‚·ã‚°ãƒŠãƒªãƒ³ã‚°ã‚µãƒ¼ãƒãƒ¼ã®å†—é•·åŒ–**:
```typescript
const signalingServers = [
  'https://signaling1.orbitscore.com',
  'https://signaling2.orbitscore.com',
  'https://signaling3.orbitscore.com'
];

let currentServerIndex = 0;

function connectToSignalingServer(): Socket {
  const socket = io(signalingServers[currentServerIndex]);

  socket.on('connect_error', () => {
    console.error(`[Signaling Server Error] ${signalingServers[currentServerIndex]}`);
    currentServerIndex = (currentServerIndex + 1) % signalingServers.length;
    console.log(`[Switching to Backup] ${signalingServers[currentServerIndex]}`);
    socket.close();
    return connectToSignalingServer(); // æ¬¡ã®ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶š
  });

  return socket;
}
```

**æˆæœç‰©**: å®‰å®šã—ãŸæ¥ç¶š

---

### Phase 7: ãƒ†ã‚¹ãƒˆãƒ»ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆæ¨å®š: 2-3æ—¥ï¼‰

#### 7.1 ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª

**æ‰‹å‹•ãƒ†ã‚¹ãƒˆ**:
- [ ] 2äººã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆãƒ»å‚åŠ 
- [ ] 3äººã§åŒæ™‚ç·¨é›†ï¼ˆã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãªã—ï¼‰
- [ ] ãƒ›ã‚¹ãƒˆãŒåˆ‡æ–­ â†’ BackupãŒæ˜‡æ ¼
- [ ] ãƒ›ã‚¹ãƒˆãŒå†æ¥ç¶š â†’ Memberã¨ã—ã¦å‚åŠ 
- [ ] å…¨å“¡åŒæ™‚ã«ã‚³ãƒ¼ãƒ‰å®Ÿè¡Œ â†’ éŸ³ãŒåŒæœŸ
- [ ] ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ‡æ–­ â†’ è‡ªå‹•å†æ¥ç¶š

**è² è·ãƒ†ã‚¹ãƒˆ**:
- [ ] 10äººåŒæ™‚æ¥ç¶š
- [ ] 100è¡Œã®ã‚³ãƒ¼ãƒ‰ã‚’åŒæ™‚ç·¨é›†
- [ ] 5åˆ†é–“ã®é€£ç¶šã‚»ãƒƒã‚·ãƒ§ãƒ³

#### 7.2 ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `packages/vscode-extension-collab/README.md`

```markdown
# OrbitScore Collaboration Extension

P2P real-time collaboration for OrbitScore live coding.

## Features
- âœ… P2P connection (WebRTC)
- âœ… Host migration (no single point of failure)
- âœ… Real-time code sync (CRDT)
- âœ… Cursor position sync
- âœ… Code execution sync
- âœ… Engine state sync

## Installation
```bash
code --install-extension orbitscore-collab.vsix
```

## Usage

### Create Session (Host)
1. Open Command Palette (Cmd+Shift+P)
2. Run `OrbitScore: Create Collaboration Session`
3. Share Room ID with participants

### Join Session (Guest)
1. Open Command Palette (Cmd+Shift+P)
2. Run `OrbitScore: Join Collaboration Session`
3. Enter Room ID

## Architecture
- **P2P**: WebRTC (simple-peer)
- **CRDT**: Yjs (conflict-free sync)
- **Signaling**: Socket.IO server

## Troubleshooting

### Connection Failed
- Check firewall settings
- Try different signaling server (automatic fallback)

### Audio Not Synced
- This is expected! Each user runs code on their own SuperCollider.
- Network latency: 10-50ms is normal.
```

**æˆæœç‰©**: æœ¬ç•ªãƒªãƒªãƒ¼ã‚¹å¯èƒ½ãªå”èª¿ç·¨é›†æ©Ÿèƒ½

---

## ğŸ“Š ç·æ¨å®šå·¥æ•°

| Phase | å†…å®¹ | æ¨å®šå·¥æ•° | é›£æ˜“åº¦ |
|-------|------|---------|--------|
| Phase 1 | åŸºç›¤å®Ÿè£…ï¼ˆP2Pæ¥ç¶šï¼‰ | 1é€±é–“ | â­â­â­ |
| Phase 2 | ãƒ‡ãƒ¼ã‚¿åŒæœŸï¼ˆCRDTï¼‰ | 1é€±é–“ | â­â­â­â­ |
| Phase 3 | ã‚³ãƒ¼ãƒ‰å®Ÿè¡ŒåŒæœŸ | 3-5æ—¥ | â­â­ |
| Phase 4 | UI/UXå®Ÿè£… | 1é€±é–“ | â­â­ |
| **Phase 4.5** | **ãƒãƒ£ãƒƒãƒˆãƒ»ã‚³ãƒ¡ãƒ³ãƒˆæ©Ÿèƒ½** | **1é€±é–“** | **â­â­** |
| Phase 5 | ãƒ›ã‚¹ãƒˆãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ | 3-5æ—¥ | â­â­â­â­ |
| Phase 6 | å®‰å®šæ€§ãƒ»ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° | 3-5æ—¥ | â­â­â­ |
| Phase 7 | ãƒ†ã‚¹ãƒˆãƒ»ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ | 2-3æ—¥ | â­ |
| **åˆè¨ˆ** | | **ç´„5-6é€±é–“** | |

**å®Ÿä½œæ¥­æ™‚é–“**: ç´„1.5-2ãƒ¶æœˆï¼ˆ1æ—¥4-6æ™‚é–“ä½œæ¥­æƒ³å®šï¼‰

---

## ğŸ¯ æœ€å°é™ã®å®Ÿè£…ï¼ˆMVPç‰ˆï¼‰

æ—©æœŸãƒªãƒªãƒ¼ã‚¹ãŒå¿…è¦ãªå ´åˆã€ä»¥ä¸‹ã®ã‚¹ã‚³ãƒ¼ãƒ—ã§ **2-3é€±é–“** ã«çŸ­ç¸®å¯èƒ½ï¼š

### å«ã‚€ã‚‚ã®ï¼ˆMVPï¼‰
- âœ… Phase 1: P2Pæ¥ç¶šåŸºç›¤
- âœ… Phase 2: CRDTçµ±åˆï¼ˆåŸºæœ¬åŒæœŸï¼‰
- âœ… Phase 3: ã‚³ãƒ¼ãƒ‰å®Ÿè¡ŒåŒæœŸ
- âœ… Phase 4: æœ€å°é™UIï¼ˆCreate/Join Sessionï¼‰
- âœ… Phase 7: åŸºæœ¬ãƒ†ã‚¹ãƒˆ

### çœç•¥ã™ã‚‹ã‚‚ã®ï¼ˆv1.1ä»¥é™ã«å»¶æœŸï¼‰
- âŒ ãƒ›ã‚¹ãƒˆãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ â†’ ãƒ›ã‚¹ãƒˆãŒè½ã¡ãŸã‚‰ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†
- âŒ ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®è¡¨ç¤º â†’ ãƒ†ã‚­ã‚¹ãƒˆåŒæœŸã®ã¿
- âŒ è‡ªå‹•å†æ¥ç¶š â†’ æ‰‹å‹•ã§å†æ¥ç¶š
- âŒ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚µãƒ¼ãƒãƒ¼ â†’ å˜ä¸€ã‚·ã‚°ãƒŠãƒªãƒ³ã‚°ã‚µãƒ¼ãƒãƒ¼

**MVPç‰ˆã®åˆ¶ç´„**:
- ãƒ›ã‚¹ãƒˆãŒåˆ‡æ–­ã—ãŸã‚‰ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†ï¼ˆå†ä½œæˆãŒå¿…è¦ï¼‰
- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä¸å®‰å®šæ™‚ã«å†æ¥ç¶šãŒå¿…è¦

---

## âš ï¸ æ³¨æ„ç‚¹ãƒ»èª²é¡Œ

### 1. ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªåŒæœŸã®è€ƒãˆæ–¹

**âŒ é–“é•ã£ãŸã‚¢ãƒ—ãƒ­ãƒ¼ãƒ**:
éŸ³å£°ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çµŒç”±ã§é€ä¿¡
- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é…å»¶ã§ãƒªã‚ºãƒ ãŒãšã‚Œã‚‹
- å¸¯åŸŸå¹…ãŒå¿…è¦
- ã‚¨ã‚³ãƒ¼ãŒç™ºç”Ÿ

**âœ… æ­£ã—ã„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ**:
å„è‡ªã®SuperColliderã§åŒã˜ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œ
- ã‚³ãƒ¼ãƒ‰å®Ÿè¡Œã‚¤ãƒ™ãƒ³ãƒˆã®ã¿åŒæœŸï¼ˆè»½é‡ï¼‰
- å„è‡ªã®ãƒ­ãƒ¼ã‚«ãƒ«ã§éŸ³ã‚’ç”Ÿæˆ
- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é…å»¶: 10-50msç¨‹åº¦ï¼ˆè¨±å®¹ç¯„å›²å†…ï¼‰

**çµæœ**: å…¨å“¡ãŒã»ã¼åŒæœŸã—ãŸéŸ³æ¥½ä½“é¨“ã‚’å¾—ã‚‹

### 2. OrbitScoreåˆ©ç”¨æ™‚ã®åˆ¶ç´„

**å•é¡Œ**: OrbitScoreã¯ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ éŸ³å£°ç”Ÿæˆãƒ„ãƒ¼ãƒ«ãªã®ã§ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é…å»¶ã®å½±éŸ¿ã‚’å—ã‘ã‚‹

**å¯¾ç­–**:
- **ã‚³ãƒ¼ãƒ‰å®Ÿè¡Œã®é…å»¶**: 10-50msï¼ˆè¨±å®¹ç¯„å›²å†…ã€äººé–“ã¯æ°—ã¥ã‹ãªã„ï¼‰
- **ã‚¨ãƒ‡ã‚£ã‚¿ç·¨é›†ã®é…å»¶**: CRDTï¼ˆY.jsï¼‰ã«ã‚ˆã‚Šæœ€å°åŒ–ï¼ˆ1-10msï¼‰

**Live Shareã‚„Open Collaboration toolsã¨ã®æ¯”è¼ƒ**:
- Live Share: ã‚¨ãƒ‡ã‚£ã‚¿åŒæœŸã®ã¿ã€OrbitScoreã‚¨ãƒ³ã‚¸ãƒ³çŠ¶æ…‹ã¯éåŒæœŸ
- OrbitScore Collab: **ã‚¨ãƒ‡ã‚£ã‚¿ + ã‚¨ãƒ³ã‚¸ãƒ³çŠ¶æ…‹ + ã‚³ãƒ¼ãƒ‰å®Ÿè¡Œ**ã‚’å…¨ã¦åŒæœŸ

### 3. ã‚·ã‚°ãƒŠãƒªãƒ³ã‚°ã‚µãƒ¼ãƒãƒ¼ã®é‹ç”¨

**ã‚³ã‚¹ãƒˆ**:
- ç„¡æ–™PaaSï¼ˆHeroku, Railway, Renderï¼‰ã§æœˆ$0-7
- æœ‰æ–™ã‚µãƒ¼ãƒãƒ¼ï¼ˆLinode, DigitalOceanï¼‰ã§æœˆ$5-10

**ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£**:
- 1ã‚µãƒ¼ãƒãƒ¼ã§100-200åŒæ™‚ã‚»ãƒƒã‚·ãƒ§ãƒ³å¯¾å¿œå¯èƒ½
- è² è·ãŒé«˜ã„å ´åˆã¯è¤‡æ•°ã‚µãƒ¼ãƒãƒ¼ã«åˆ†æ•£

**ä»£æ›¿æ¡ˆ**: P2På®Œå…¨ç‰ˆï¼ˆã‚·ã‚°ãƒŠãƒªãƒ³ã‚°ã‚µãƒ¼ãƒãƒ¼ä¸è¦ï¼‰
- WebRTC + STUN/TURNã‚µãƒ¼ãƒãƒ¼
- NAT traversalå•é¡Œï¼ˆå®Ÿè£…ãŒè¤‡é›‘ï¼‰
- åˆæœŸãƒªãƒªãƒ¼ã‚¹ã§ã¯è¦‹é€ã‚Šã€å°†æ¥çš„ã«æ¤œè¨

### 4. NAT/ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«å•é¡Œ

**å•é¡Œ**: ä¼æ¥­ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚„å³æ ¼ãªãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ç’°å¢ƒã§ã¯P2Pæ¥ç¶šãŒå¤±æ•—ã™ã‚‹

**è§£æ±ºç­–**: TURNã‚µãƒ¼ãƒãƒ¼çµŒç”±ã§ãƒªãƒ¬ãƒ¼
- TURN: STUN/TURNç„¡æ–™ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆGoogle STUN, Twilio TURNç­‰ï¼‰
- ã‚³ã‚¹ãƒˆ: ç„¡æ–™ç‰ˆã§ååˆ†ï¼ˆæœˆ10GBä»¥ä¸‹ï¼‰

**è¨­å®š**:
```typescript
const peer = new SimplePeer({
  initiator,
  trickle: false,
  config: {
    iceServers: [
      { urls: 'stun:stun.l.google.com:19302' },
      {
        urls: 'turn:turn.example.com:3478',
        username: 'user',
        credential: 'pass'
      }
    ]
  }
});
```

### 5. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

**è„…å¨**:
- æ‚ªæ„ã®ã‚ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒéƒ¨å±‹ã«ä¾µå…¥
- ä»»æ„ã‚³ãƒ¼ãƒ‰å®Ÿè¡Œï¼ˆSuperColliderçµŒç”±ï¼‰

**å¯¾ç­–**:
- ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã¯128bit UUIDï¼ˆæ¨æ¸¬å›°é›£ï¼‰
- éƒ¨å±‹ã«ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
- ãƒ›ã‚¹ãƒˆãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’Kickå¯èƒ½
- ã‚³ãƒ¼ãƒ‰å®Ÿè¡Œã¯å„è‡ªã®SuperColliderã§ï¼ˆã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ï¼‰

---

## âš ï¸ é‡è¦ãªè¨­è¨ˆä¸Šã®æ³¨æ„ç‚¹ï¼ˆè¿½åŠ æŒ‡æ‘˜ã¸ã®å¯¾å¿œï¼‰

### 1. éŸ³ã®æ’ä»–åˆ¶å¾¡

**å•é¡Œ**: è¤‡æ•°äººãŒåŒæ™‚ã«éŸ³ã‚’å‡ºã™ã¨ã€åŒã˜éŸ³ãŒé‡è¤‡ã—ã¦çˆ†éŸ³ã«ãªã‚‹

**è§£æ±ºç­–**: 3ã¤ã®éŸ³å£°å‡ºåŠ›ãƒ¢ãƒ¼ãƒ‰ã‚’å®Ÿè£…ï¼ˆPhase 3.2å‚ç…§ï¼‰
- **Individual Mode** (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ): è‡ªåˆ†ãŒå®Ÿè¡Œã—ãŸéŸ³ã ã‘å‡ºã‚‹
- **Host-Only Mode**: ãƒ›ã‚¹ãƒˆã ã‘ãŒéŸ³ã‚’å‡ºã›ã‚‹
- **Shared Mode**: å…¨å“¡ãŒç•°ãªã‚‹ãƒˆãƒ©ãƒƒã‚¯ã‚’æ‹…å½“ï¼ˆä¸Šç´šè€…å‘ã‘ï¼‰

**å®Ÿè£…ç®‡æ‰€**: `src/sync/audio-output-mode.ts`

### 2. ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ä¿è­·

**å•é¡Œ**: éŸ³ãŒæ€¥ã«å‡ºã‚‹/æ­¢ã¾ã‚‹ã¨ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ãŒç ´æã™ã‚‹å¯èƒ½æ€§

**è§£æ±ºç­–**: ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³/ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆæ©Ÿèƒ½ã‚’å®Ÿè£…ï¼ˆPhase 3.2å‚ç…§ï¼‰
- ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³: 50ms
- ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ: 100ms
- SuperColliderã®ãƒã‚¹ã‚¿ãƒ¼ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’å¾ã€…ã«å¤‰åŒ–

**é©ç”¨ã‚·ãƒ¼ãƒ³**:
- ãƒ›ã‚¹ãƒˆãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ™‚
- éŸ³å£°å‡ºåŠ›ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆæ™‚
- ç·Šæ€¥åœæ­¢æ™‚ï¼ˆPanic Buttonï¼‰

**å®Ÿè£…ç®‡æ‰€**: `src/audio/speaker-protection.ts`

### 3. ãƒ›ã‚¹ãƒˆãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ç¢ºèªãƒ•ãƒ­ãƒ¼

**å•é¡Œ**: å‹æ‰‹ã«ãƒ›ã‚¹ãƒˆãŒå¤‰ã‚ã‚‹ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒå°ç„¡ã—ã«ãªã‚‹

**è§£æ±ºç­–**: 3æ®µéšã®å®‰å…¨ãªå¼•ãç¶™ããƒ•ãƒ­ãƒ¼ï¼ˆPhase 5.1å‚ç…§ï¼‰

#### ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ›ã‚¹ãƒˆåˆ‡æ–­æ¤œå‡º
- ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆé€”çµ¶ï¼ˆ15ç§’ï¼‰ã§æ¤œå‡º

#### ã‚¹ãƒ†ãƒƒãƒ—2: ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
- **å…¨ãƒ¡ãƒ³ãƒãƒ¼ã«ç¢ºèª**: "Would you like to take over as the new host?"
- **æœ€åˆã«OKã—ãŸäºº**ãŒæ–°ãƒ›ã‚¹ãƒˆã«æ˜‡æ ¼
- ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆ30ç§’ï¼‰â†’ èª°ã‚‚å¿œç­”ã—ãªã„å ´åˆã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†

#### ã‚¹ãƒ†ãƒƒãƒ—3: å®‰å…¨ãªå¼•ãç¶™ã
1. æ—§ãƒ›ã‚¹ãƒˆã®éŸ³ã‚’ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
2. çŠ¶æ…‹åŒæœŸç¢ºèª
3. æ–°ãƒ›ã‚¹ãƒˆã®éŸ³ã‚’ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³
4. å…¨å“¡ã«é€šçŸ¥

**å®Ÿè£…ç®‡æ‰€**: `src/p2p/host-migration.ts`

### 4. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

**ã‚±ãƒ¼ã‚¹1: è¤‡æ•°äººãŒåŒæ™‚ã«ã€ŒYesã€ã‚’æŠ¼ã—ãŸ**
- æœ€åˆã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ãŸäººãŒå„ªå…ˆï¼ˆã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã§åˆ¤å®šï¼‰

**ã‚±ãƒ¼ã‚¹2: æ–°ãƒ›ã‚¹ãƒˆã‚‚ç›´å¾Œã«åˆ‡æ–­ã—ãŸ**
- å†åº¦ç¢ºèªãƒ•ãƒ­ãƒ¼ã‚’é–‹å§‹ï¼ˆæœ€å¤§3å›ã¾ã§ï¼‰
- 3å›å¤±æ•—ã—ãŸã‚‰ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†

**ã‚±ãƒ¼ã‚¹3: éŸ³ãŒãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆä¸­ã«æ–°ã—ã„ã‚³ãƒ¼ãƒ‰ãŒå®Ÿè¡Œã•ã‚ŒãŸ**
- ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆå®Œäº†ã¾ã§å®Ÿè¡Œã‚’ã‚­ãƒ¥ãƒ¼ã«æºœã‚ã‚‹
- ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³å¾Œã«å®Ÿè¡Œ

---

## ğŸ¤” æ‹¡å¼µã‚¢ã‚¤ãƒ‡ã‚¢ï¼ˆå°†æ¥ç‰ˆï¼‰

### v1.5: ãƒœã‚¤ã‚¹ãƒãƒ£ãƒƒãƒˆçµ±åˆ
- WebRTCéŸ³å£°é€šè©±
- ã‚³ãƒ©ãƒœãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä¸­ã«ä¼šè©±å¯èƒ½

### v2.0: ã‚»ãƒƒã‚·ãƒ§ãƒ³éŒ²ç”»ãƒ»å†ç”Ÿ
- å…¨ç·¨é›†å±¥æ­´ã‚’è¨˜éŒ²
- ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³å†ç”Ÿï¼ˆæ•™è‚²ç”¨ï¼‰

### v2.5: AI Assistantçµ±åˆ
- ã‚³ãƒ¼ãƒ‰è£œå®Œãƒ»ææ¡ˆã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å…±æœ‰
- AIãŒéŸ³æ¥½ç†è«–çš„ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›

---

## ğŸš€ é–‹ç™ºé–‹å§‹æ‰‹é †

ã“ã®ãƒ—ãƒ©ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹å ´åˆã€ä»¥ä¸‹ã®æ‰‹é †ã§é–‹å§‹ã—ã¾ã™ï¼š

### 1. Issueä½œæˆ
```bash
gh issue create \
  --title "P2På”èª¿ãƒ©ã‚¤ãƒ–ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æ©Ÿèƒ½é–‹ç™º" \
  --body "$(cat docs/COLLABORATION_FEATURE_PLAN.md)" \
  --label "enhancement,collaboration,p2p"
```

### 2. ãƒ–ãƒ©ãƒ³ãƒä½œæˆ
```bash
git checkout develop
git pull origin develop
git checkout -b <issue-number>-p2p-collaboration
```

### 3. ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åˆæœŸåŒ–
```bash
cd packages
mkdir vscode-extension-collab
cd vscode-extension-collab

npm init -y

npm install --save-dev \
  @types/vscode@^1.99.0 \
  typescript@^5.9.0

npm install \
  simple-peer@^9.11.1 \
  socket.io-client@^4.5.0 \
  yjs@^13.6.0 \
  y-webrtc@^10.2.5 \
  uuid@^9.0.0 \
  eventemitter3@^5.0.0
```

### 4. ã‚·ã‚°ãƒŠãƒªãƒ³ã‚°ã‚µãƒ¼ãƒãƒ¼æ§‹ç¯‰
```bash
cd packages
mkdir collab-signaling-server
cd collab-signaling-server

npm init -y
npm install express socket.io

# server.tsä½œæˆï¼ˆä¸Šè¨˜Phase 1.2å‚ç…§ï¼‰
```

### 5. Phase 1å®Ÿè£…é–‹å§‹
```bash
# P2Pæ¥ç¶šãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼å®Ÿè£…
touch src/p2p/connection-manager.ts

# é–‹ç™ºé–‹å§‹ï¼
```

---

## ğŸ“š é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- **Electronç‰ˆã‚¢ãƒ—ãƒª**: `docs/ELECTRON_APP_PLAN.md`
- **DSLä»•æ§˜**: `docs/INSTRUCTION_ORBITSCORE_DSL.md`
- **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒ«**: `docs/PROJECT_RULES.md`
- **å®Ÿè£…è¨ˆç”»**: `docs/IMPLEMENTATION_PLAN.md`

---

## ğŸ¯ æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

**æ¨å¥¨å®Ÿè£…é †åº**:
1. **Electronç‰ˆã‚¢ãƒ—ãƒª** (2.5-4é€±é–“) - UI/UXã®åŸºç›¤
2. **P2På”èª¿æ©Ÿèƒ½** (4-5é€±é–“) - ã‚³ãƒ©ãƒœãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç’°å¢ƒ

**ç†ç”±**:
- Electronç‰ˆã§å®‰å®šã—ãŸã‚¨ãƒ‡ã‚£ã‚¿åŸºç›¤ã‚’æ§‹ç¯‰
- ãã®ä¸Šã«å”èª¿æ©Ÿèƒ½ã‚’è¿½åŠ ã™ã‚‹æ–¹ãŒåŠ¹ç‡çš„
- VS Code Extensionç‰ˆã§å”èª¿æ©Ÿèƒ½ã®ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—å®Ÿè£…ã‚‚å¯èƒ½

---

**ã“ã®ãƒ—ãƒ©ãƒ³ã«é–¢ã™ã‚‹è³ªå•ã‚„ææ¡ˆãŒã‚ã‚Œã°ã€Issue/PRã§è­°è«–ã—ã¦ãã ã•ã„ã€‚**
