# OrbitScore Audio-Based DSL Implementation Plan

## Overview

Implementation plan for the new audio-based OrbitScore DSL as defined in `INSTRUCTION_ORBITSCORE_DSL.md`.

**Single Source of Truth**: [`../core/INSTRUCTION_ORBITSCORE_DSL.md`](../core/INSTRUCTION_ORBITSCORE_DSL.md)

## Migration Status

- **Old System**: MIDI-based DSL (deprecated)
- **New System**: Audio-based DSL (‚úÖ Core implementation complete)
- **Migration Date**: December 25, 2024
- **Completion Status**: ~90% (Core features complete, advanced features pending)
- **Refactoring Status**: ‚úÖ Phase 1-7 Complete (All major refactoring completed)
- **DSL Version**: v3.0 (Underscore prefix + Unidirectional toggle)

## Current Implementation Summary

### ‚úÖ Completed (tested)
- **Parser**: Full DSL syntax support with 50 tests
- **Object-Oriented Architecture**: Global and Sequence classes
- **Audio Engine**: WAV loading, slicing, SuperCollider-based playback
- **Transport System**: Scheduling, polymeter, mute/unmute
- **VS Code Extension**: Syntax highlighting, autocomplete, execution
- **Timing Calculation**: Hierarchical play patterns
- **Method Chaining**: Fluent API across all components
- **Audio Slicing (chop)**: SuperCollider buffer-based partial playback
- **CLI with Timeout**: Auto-stop feature for testing
- **Real Audio Playback**: Verified with kick, snare, hihat, bass, arpeggio

### ‚ö†Ô∏è Partially Implemented
- **Audio Formats**: Only WAV fully supported (AIFF/MP3/MP4 placeholders)
- **Time Stretching**: Basic tempo adjustment (needs quality algorithm)
- **Pitch Shifting**: Placeholder only (needs DSP implementation)
- **Infinite Loop**: length(n) provides finite loops (needs loop() method)

### üìã Not Yet Implemented
- **Force Modifier**: `.force` for immediate transport
- **Composite Meters**: `((3 by 4)(2 by 4))` syntax
- **Advanced Audio**: offset, reverse, fade
- **DAW Plugin**: VST/AU development (Phase A5)

### üìä Testing Coverage
- **Total Tests**: 225 passed, 23 skipped (248 total) = 90.7%
- **Parser Tests**: 50/50
- **Interpreter Tests**: 83/83
- **DSL v3.0 Tests**: 56/56 (Unidirectional Toggle, Underscore Prefix, Gain/Pan)
- **Audio Engine Tests**: 15/15 (SuperCollider integration)
- **Real Audio Tests**: Verified with actual playback (kick, snare, hihat, bass, arpeggio)

## Implementation Phases

### Phase A1: New Parser Implementation ‚úÖ COMPLETED

**Goal**: Implement parser for the audio-based DSL syntax
**Status**: Fully implemented and tested

#### A1.1 Tokenizer Updates
- [x] Support for `by` keyword (meter syntax)
- [x] Support for `.` operator (method calls)
- [x] Support for `var` keyword
- [x] Support for `init` keyword
- [x] Support for parentheses in expressions

#### A1.2 Global Parameter Parsing
```js
global.tempo(140)
global.tick(480)
global.beat(4 by 4)
global.beat((3 by 4)(2 by 4))
global.key(C)
```
- [x] Parse method call syntax
- [x] Parse `n by m` meter notation
- [ ] Parse composite meters (partially)
- [ ] Parse shorthand aliases (not implemented, using autocomplete instead)

#### A1.3 Initialization Parsing
```js
var global = init GLOBAL
var seq1 = init GLOBAL.seq
```
- [x] Parse variable declarations
- [x] Parse init expressions (both `init GLOBAL` and `init global.seq`)
- [x] Track initialized sequences

#### A1.4 Sequence Configuration
```js
seq1.tempo(120)
seq1.beat(17 by 8)
seq1.audio("../audio/piano1.wav").chop(6)
```
- [x] Parse sequence method calls
- [x] Parse audio loading
- [x] Parse chop parameters

#### A1.5 Play Structure Parsing
```js
seq1.play(0)
seq1.play((0)(0))
seq1.play((0)((0)(0)))
seq1.play(0.chop(5), 0.chop(4))
seq1.play(1).fixpitch(0)
```
- [x] Parse nested play structures (both `(1, 2)` and `(1)(2)` syntax)
- [x] Parse functional form (.chop, .time)
- [x] Parse fixpitch modifier
- [x] Parse slice numbers (1-n for chop(n))

#### A1.6 Transport Command Parsing
```js
global.start()
global.start.force()
global.loop(seq1, seq2)
seq1.mute()
```
- [x] Parse transport methods
- [ ] Parse force modifier (not yet implemented)
- [x] Parse targeted sequences

#### A1.7 Testing
- [x] Create test suite for all syntax variants (31 parser tests)
- [x] Generate IR for sample files
- [x] Validate parser error handling

### Phase A2: Audio Engine Integration ‚úÖ MOSTLY COMPLETED

**Goal**: Implement audio playback and processing
**Status**: Core features implemented, some advanced features pending

#### A2.1 Audio File Loading
- [x] WAV format support (fully implemented)
- [ ] AIFF format support (placeholder)
- [ ] MP3 format support (placeholder)
- [ ] MP4 format support (placeholder)
- [x] Sample rate conversion to 48kHz

#### A2.2 Audio Slicing
- [x] Implement chop(n) functionality
- [x] Calculate slice boundaries
- [x] Handle edge cases (chop(1), default behavior)

#### A2.3 Time-Stretching
- [x] Default playback (tempo-adjusted)
- [ ] Implement quality time-stretch algorithm (WSOLA)
- [ ] Maintain audio quality

#### A2.4 Pitch Shifting
- [ ] Implement fixpitch(n) functionality (placeholder only)
- [ ] Granular synthesis or Phase Vocoder
- [ ] Preserve formants option

#### A2.5 Audio Output
- [x] Web Audio API integration (node-web-audio-api)
- [x] Buffer management
- [ ] Latency optimization

### Phase A3: Transport System ‚úÖ MOSTLY COMPLETED

**Goal**: Implement real-time transport controls
**Status**: Core transport implemented, some advanced features pending

#### A3.1 Global Transport
- [x] run() - start transport
- [ ] start.force() - immediate start (not implemented)
- [x] loop() - loop mode
- [ ] loop.force() - immediate loop (not implemented)
- [x] stop() - stop transport

#### A3.2 Sequence Transport
- [x] Per-sequence run/loop/stop
- [x] Mute/unmute functionality
- [x] Targeted transport (specific sequences)

#### A3.3 Scheduling
- [x] Bar boundary quantization
- [x] Independent sequence timing
- [x] Polymeter support (tested with 5/4 vs 4/4)

#### A3.4 State Management
- [x] Track playing sequences
- [x] Handle sequence synchronization
- [ ] Manage loop points (partial)

### Phase A4: VS Code Extension Update ‚úÖ COMPLETED

**Goal**: Update extension for audio DSL support
**Status**: Fully implemented with context-aware features

#### A4.1 Syntax Highlighting
- [x] Update grammar for new syntax
- [x] Highlight method calls
- [x] Highlight transport commands

#### A4.2 Command Execution
- [x] Implement Cmd+Enter execution
- [x] Parse selected text
- [x] Send to engine via IPC

#### A4.3 IntelliSense and Autocomplete
- [x] Method autocomplete
  - [x] Context-aware suggestions (global vs sequence methods)
  - [x] Method signature display
  - [x] Quick info tooltips
- [x] Parameter hints
  - [x] Type information
  - [x] Valid value ranges
  - Example values
- [ ] Documentation hover
  - Method descriptions
  - Usage examples
  - Links to documentation
- [ ] Snippet support
  - Common patterns (init, play, etc.)
  - Template expansion
  - Cursor positioning
- [ ] NO abbreviations in DSL
  - Full readable names only
  - Speed through autocomplete, not shortcuts
  - Maintain code readability

#### A4.4 Diagnostics
- [ ] Real-time syntax checking
- [ ] Error highlighting
- [ ] Warning for deprecated features

### Phase A5: DAW Plugin Development

**Goal**: Create VST/AU plugin for DAW integration

#### A5.1 Plugin Architecture
- [ ] VST3 wrapper implementation
- [ ] AU wrapper implementation
- [ ] IPC with OrbitScore engine

#### A5.2 Audio Routing
- [ ] Select sequence output
- [ ] Multi-channel support
- [ ] Sync with DAW transport

#### A5.3 Parameter Automation
- [ ] Expose parameters to DAW
- [ ] Handle automation curves
- [ ] Real-time parameter updates

## Testing Strategy

### Unit Tests
- Parser: All syntax variants
- Audio Engine: File formats, slicing, stretching
- Transport: State transitions, timing

### Integration Tests
- End-to-end playback
- Multi-sequence synchronization
- Editor command execution

### Performance Tests
- Audio latency measurement
- CPU usage optimization
- Memory management

## Success Criteria

1. **Parser**: Successfully parse all DSL syntax from [`../core/INSTRUCTION_ORBITSCORE_DSL.md`](../core/INSTRUCTION_ORBITSCORE_DSL.md)
2. **Audio**: Play sliced audio with tempo adjustment and optional pitch preservation
3. **Transport**: Execute all transport commands with proper timing
4. **Editor**: Cmd+Enter execution works for all commands
5. **DAW**: Plugin routes audio to DAW tracks

## Migration Path

### Deprecated Components
- `packages/engine/src/midi.ts` - MIDI output
- `packages/engine/src/pitch.ts` - Degree to MIDI conversion
- Old parser for MIDI-based syntax

### New Components Needed
- `packages/engine/src/audio/` - Audio engine
- `packages/engine/src/transport/` - Transport system
- `packages/engine/src/parser/audio-parser.ts` - New parser
- `packages/daw-plugin/` - DAW plugin package

## Risk Mitigation

1. **Audio Latency**: Use appropriate buffer sizes, implement look-ahead
2. **Time-Stretching Quality**: Research best algorithms (Rubber Band, SoundTouch)
3. **Cross-Platform**: Initially focus on macOS, plan for Windows/Linux
4. **DAW Compatibility**: Test with major DAWs (Ableton, Logic, Cubase)

## Timeline Estimate

- Phase A1 (Parser): 1 week
- Phase A2 (Audio Engine): 2-3 weeks
- Phase A3 (Transport): 1 week
- Phase A4 (VS Code Extension): 1 week
- Phase A5 (DAW Plugin): 2-3 weeks

**Total**: 7-10 weeks for full implementation

## Future Improvements (Post DSL v3.0)

### ‰∏≠ÂÑ™ÂÖàÂ∫¶ÔºàÊ¨°„ÅÆPR„ÅßÂØæÂá¶ÂèØËÉΩÔºâ

#### ‚ö†Ô∏è „Ç®„ÉÉ„Ç∏„Ç±„Éº„Çπ„ÉÜ„Çπ„Éà„ÅÆËøΩÂä†
**Èñ¢ÈÄ£Issue**: Claude Review #45 È†ÖÁõÆ5
**ÁõÆÁöÑ**: RUN/LOOP/MUTE„Ç≥„Éû„É≥„Éâ„ÅÆÂ†ÖÁâ¢ÊÄßÂêë‰∏ä
**ÂÜÖÂÆπ**:
- Á©∫„ÅÆ„Ç≥„Éû„É≥„Éâ: `RUN()`, `LOOP()`, `MUTE()`
- ÈáçË§á„Ç∑„Éº„Ç±„É≥„Çπ: `RUN(kick, kick, kick)`
- Â≠òÂú®„Åó„Å™„ÅÑ„Ç∑„Éº„Ç±„É≥„Çπ: `RUN(nonexistent)`ÔºàÁèæÂú®„ÅØË≠¶Âëä„ÅÆ„ÅøÔºâ
- RUN‚ÜíLOOPÈÅ∑ÁßªÊôÇ„ÅÆÊåôÂãïÁ¢∫Ë™ç
- Âêå‰∏Ä„Ç∑„Éº„Ç±„É≥„Çπ„ÅÆË§áÊï∞„Ç∞„É´„Éº„ÉóÊâÄÂ±û

**ÂÆüË£ÖÂ†¥ÊâÄ**: `tests/interpreter/unidirectional-toggle.spec.ts`

#### ‚ö†Ô∏è „Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÊúÄÈÅ©Âåñ
**Èñ¢ÈÄ£Issue**: Claude Review #45 È†ÖÁõÆ4
**ÁõÆÁöÑ**: handleLoopCommand„ÅÆÂá¶ÁêÜÂäπÁéáÂêë‰∏ä
**ÂÜÖÂÆπ**:
- ÁèæÂú®„ÅÆ‰∫åÈáç„É´„Éº„Éó„ÇíÂçò‰∏Ä„É´„Éº„Éó„Å´Áµ±Âêà
- oldLoopGroup„Å®newLoopGroup„ÅÆÂ∑ÆÂàÜÂá¶ÁêÜ„ÇíÊúÄÈÅ©Âåñ
- „É°„É¢„É™„Ç¢„É≠„Ç±„Éº„Ç∑„Éß„É≥ÂâäÊ∏õ

**ÂÆüË£ÖÂ†¥ÊâÄ**: `packages/engine/src/interpreter/process-statement.ts`
**Êé®ÂÆöÂ∑•Êï∞**: 0.5Êó•

### ‰ΩéÂÑ™ÂÖàÂ∫¶ÔºàÂ∞ÜÊù•ÁöÑ„Å™ÊîπÂñÑÔºâ

#### üìö „Éâ„Ç≠„É•„É°„É≥„ÉàÂÖÖÂÆü
**Èñ¢ÈÄ£Issue**: Claude Review #45 È†ÖÁõÆ6
**ÁõÆÁöÑ**: ÂÆüË∑µÁöÑ„Å™„É¶„Éº„Çπ„Ç±„Éº„Çπ„ÅÆÊèê‰æõ
**ÂÜÖÂÆπ**:
- „Çà„ÇäÂ§ö„Åè„ÅÆÂÆüÁî®‰æãÔºà„É©„Ç§„Éñ„Ç≥„Éº„Éá„Ç£„É≥„Ç∞„Éë„Çø„Éº„É≥Ôºâ
- DSL v2.0„Åã„Çâv3.0„Å∏„ÅÆÁßªË°å„Ç¨„Ç§„Éâ
- RUN/LOOP/MUTE„ÅÆÁµÑ„ÅøÂêà„Çè„Åõ„Éë„Çø„Éº„É≥ÈõÜ
- „Éà„É©„Éñ„É´„Ç∑„É•„Éº„ÉÜ„Ç£„É≥„Ç∞„Ç¨„Ç§„Éâ

**ÂÆüË£ÖÂ†¥ÊâÄ**:
- `docs/USER_MANUAL.md`
- `docs/MIGRATION_GUIDE_v3.md`ÔºàÊñ∞Ë¶è‰ΩúÊàêÔºâ
- `examples/live-coding-patterns/`ÔºàÊñ∞Ë¶è„Éá„Ç£„É¨„ÇØ„Éà„É™Ôºâ

**Êé®ÂÆöÂ∑•Êï∞**: 1-2Êó•

#### üìö „Ç∑„Éº„É†„É¨„ÇπÊõ¥Êñ∞„É≠„Ç∏„ÉÉ„ÇØ„ÅÆÁµ±‰∏Ä„Éª„Ç≥„É°„É≥„ÉàËøΩÂä†
**Èñ¢ÈÄ£Issue**: Claude Review #45 È†ÖÁõÆ1
**ÁõÆÁöÑ**: ÂÖ®_method()ÂÆüË£Ö„ÅÆ‰∏ÄË≤´ÊÄßÁ¢∫‰øù
**ÂÜÖÂÆπ**:
- ÁèæÂú®„ÅÆ_method()ÂÆüË£Ö„É¨„Éì„É•„Éº
- "Future: immediate application logic"„Ç≥„É°„É≥„Éà„ÅÆÂÖ∑‰ΩìÂåñ
- Áµ±‰∏ÄÁöÑ„Å™„Ç∑„Éº„É†„É¨„ÇπÊõ¥Êñ∞„Éë„Çø„Éº„É≥„ÅÆË®≠Ë®à
- ÂÆüË£Ö„Ç¨„Ç§„Éâ„É©„Ç§„É≥ÊñáÊõ∏Âåñ

**ÂÆüË£ÖÂ†¥ÊâÄ**:
- `packages/engine/src/core/sequence.ts`
- `packages/engine/src/core/global.ts`
- `docs/DEVELOPER_GUIDE.md`ÔºàÊñ∞Ë¶è„Çª„ÇØ„Ç∑„Éß„É≥Ôºâ

**Êé®ÂÆöÂ∑•Êï∞**: 2-3Êó•ÔºàË®≠Ë®àÂê´„ÇÄÔºâ

---

*Last Updated: 2025-10-26*
*Canonical Reference: [`../core/INSTRUCTION_ORBITSCORE_DSL.md`](../core/INSTRUCTION_ORBITSCORE_DSL.md)*