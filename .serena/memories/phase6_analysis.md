# Phase 6 ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°åˆ†æ

## èª¿æŸ»æ—¥: 2025-01-07

## å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã®è©³ç´°åˆ†æ

### ğŸ”´ æœ€å„ªå…ˆ: parse-expression.ts (339è¡Œ)

**å•é¡Œã®ãƒ¡ã‚½ãƒƒãƒ‰**:
- `parseArgument()`: **119è¡Œ** (32-150è¡Œ)
  - è¤‡æ•°ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚¿ã‚¤ãƒ—å‡¦ç†ï¼ˆè² ã®æ•°ã€æ•°å€¤ã€æ–‡å­—åˆ—ã€è­˜åˆ¥å­ã€ãƒã‚¹ãƒˆæ§‹é€ ï¼‰
  - æ˜ã‚‰ã‹ã«SRPé•å
  - å„ãƒˆãƒ¼ã‚¯ãƒ³ã‚¿ã‚¤ãƒ—ã”ã¨ã«ãƒ¡ã‚½ãƒƒãƒ‰åˆ†å‰²ãŒå¿…è¦

**ãã®ä»–ã®ãƒ¡ã‚½ãƒƒãƒ‰**:
- `parseRandomValue()`: 54è¡Œ (155-208) â† 50è¡Œè¶…
- `parsePlayWithModifier()`: 36è¡Œ (213-248)
- `parseNestedPlay()`: 58è¡Œ (253-310) â† 50è¡Œè¶…
- `parseCompositeMeter()`: 23è¡Œ (315-337)

**ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°æ–¹é‡**:
1. `parseArgument()`ã‚’åˆ†å‰²:
   - `parseNegativeNumber()`
   - `parseNumber()`
   - `parseString()`
   - `parseIdentifier()`
   - `parseParenthesizedExpression()`
2. 50è¡Œè¶…ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚‚åˆ†å‰²

**æ¨å¥¨ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ**: Expression Strategy Pattern
- å„ãƒˆãƒ¼ã‚¯ãƒ³ã‚¿ã‚¤ãƒ—ã”ã¨ã«ãƒ‘ãƒ¼ã‚µãƒ¼é–¢æ•°ã‚’ä½œæˆ
- `parseArgument()`ã‚’ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒãƒ£ãƒ¼ã¨ã—ã¦ä½¿ç”¨

---

### ğŸŸ¡ é«˜å„ªå…ˆåº¦: parse-statement.ts (250è¡Œ)

**å•é¡Œã®ãƒ¡ã‚½ãƒƒãƒ‰**:
- `parseMethodCall()`: **100è¡Œ** (112-211)
  - `.force`ä¿®é£¾å­ã®å‡¦ç†
  - ãƒ¡ã‚½ãƒƒãƒ‰ãƒã‚§ãƒ¼ãƒ³ã®å‡¦ç†
  - transport commandã®å‡¦ç†
  - è¤‡æ•°ã®è²¬å‹™

**ãã®ä»–ã®ãƒ¡ã‚½ãƒƒãƒ‰**:
- `parseVarDeclaration()`: 62è¡Œ (46-107) â† 50è¡Œè¶…
- `parseArguments()`: 33è¡Œ (216-248)
- `parseStatement()`: 18è¡Œ (24-41)

**ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°æ–¹é‡**:
1. `parseMethodCall()`ã‚’åˆ†å‰²:
   - `parseForceModifier()`
   - `parseMethodChain()`
   - `parseTransportCommand()`
2. `parseVarDeclaration()`ã‚‚åˆ†å‰²

**æ¨å¥¨ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ**: Command Pattern
- ãƒ¡ã‚½ãƒƒãƒ‰ã‚³ãƒ¼ãƒ«ã€transportã€chainã”ã¨ã«å°‚ç”¨ãƒ‘ãƒ¼ã‚µãƒ¼ä½œæˆ

---

### ğŸŸ¢ ä¸­å„ªå…ˆåº¦: audio/supercollider/event-scheduler.ts (244è¡Œ)

**å•é¡Œã®ãƒ¡ã‚½ãƒƒãƒ‰**:
- `executePlayback()`: **54è¡Œ** (170-223) â† 50è¡Œè¶…
  - ãƒ‰ãƒªãƒ•ãƒˆè¨ˆç®—
  - Gainå¤‰æ›ï¼ˆdB â†’ amplitudeï¼‰
  - OSCãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
  - 3ã¤ã®è²¬å‹™

**ãã®ä»–ã®ãƒ¡ã‚½ãƒƒãƒ‰**:
- `scheduleSliceEvent()`: 49è¡Œ (52-100)
- `start()`: 26è¡Œ (105-130)
- ãã®ä»–ã¯å°ã•ã„ï¼ˆ50è¡Œä»¥ä¸‹ï¼‰

**ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°æ–¹é‡**:
1. `executePlayback()`ã‚’åˆ†å‰²:
   - `calculateDrift()`
   - `convertGainToAmplitude()`
   - `sendPlaybackMessage()`
2. å¯èƒ½ã§ã‚ã‚Œã°`scheduleSliceEvent()`ã‚‚åˆ†å‰²

**æ¨å¥¨ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ**: Extract Method + Helper Functions
- è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã‚’ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã«æŠ½å‡º

---

### âœ… å®Œäº†æ¸ˆã¿: core/sequence.ts (365è¡Œ)

**çŠ¶æ…‹**: Phase 4-4ã§å®Œäº†
**æœ€å¤§ãƒ¡ã‚½ãƒƒãƒ‰ã‚µã‚¤ã‚º**: 36è¡Œ (`loop()`)
**è©•ä¾¡**: âœ… å…¨ãƒ¡ã‚½ãƒƒãƒ‰ãŒ50è¡Œä»¥ä¸‹
**çµè«–**: **è¿½åŠ ã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ä¸è¦**

ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã„ã®ã¯ã€å¤šãã®å°ã•ãªãƒ¡ã‚½ãƒƒãƒ‰ãŒå­˜åœ¨ã™ã‚‹ãŸã‚ã€‚
ã“ã‚Œä»¥ä¸Šã®åˆ†å‰²ã¯éåº¦ãªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–ã¨ãªã‚Šã€é€†åŠ¹æœã€‚

---

## Phase 6 å®Ÿæ–½è¨ˆç”»

### Phase 6-1: parse-expression.ts (æœ€å„ªå…ˆ)
- **ç†ç”±**: 119è¡Œã®å·¨å¤§ãƒ¡ã‚½ãƒƒãƒ‰
- **Issue**: `#32 - Refactor parse-expression.ts`
- **æœŸå¾…å‰Šæ¸›**: ç´„200è¡Œï¼ˆãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ãƒ»ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åˆ†å‰²ï¼‰

### Phase 6-2: parse-statement.ts
- **ç†ç”±**: 100è¡Œã®ãƒ¡ã‚½ãƒƒãƒ‰
- **Issue**: `#33 - Refactor parse-statement.ts`
- **æœŸå¾…å‰Šæ¸›**: ç´„100è¡Œ

### Phase 6-3: event-scheduler.ts (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)
- **ç†ç”±**: 54è¡Œã®ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆç·Šæ€¥æ€§ã¯ä½ã„ï¼‰
- **Issue**: `#34 - Refactor event-scheduler.ts`
- **æœŸå¾…å‰Šæ¸›**: ç´„50è¡Œ

### âŒ Phase 6-4: sequence.ts (ä¸è¦)
- **ç†ç”±**: æ—¢ã«ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°æ¸ˆã¿ã€å…¨ãƒ¡ã‚½ãƒƒãƒ‰50è¡Œä»¥ä¸‹
- **çµè«–**: ã‚¹ã‚­ãƒƒãƒ—

---

## å„ªå…ˆé †ä½ã®ç†ç”±

1. **parse-expression.ts**: 119è¡Œãƒ¡ã‚½ãƒƒãƒ‰ã¯æ˜ã‚‰ã‹ã«å¤§ãã™ãã‚‹ï¼ˆæœ€å„ªå…ˆï¼‰
2. **parse-statement.ts**: 100è¡Œãƒ¡ã‚½ãƒƒãƒ‰ã‚‚å¤§ãã„ï¼ˆé«˜å„ªå…ˆï¼‰
3. **event-scheduler.ts**: 54è¡Œã¯è¨±å®¹ç¯„å›²ã ãŒã€æ”¹å–„ã®ä½™åœ°ã‚ã‚Šï¼ˆä¸­å„ªå…ˆï¼‰
4. **sequence.ts**: æ—¢ã«å®Œäº†ï¼ˆä¸è¦ï¼‰

---

## æˆåŠŸåŸºæº–

Phase 6å®Œäº†å¾Œï¼š
- âœ… å…¨ãƒ¡ã‚½ãƒƒãƒ‰ãŒ50è¡Œä»¥ä¸‹
- âœ… å„ãƒ¡ã‚½ãƒƒãƒ‰ãŒå˜ä¸€è²¬ä»»
- âœ… 115 tests passed
- âœ… ãƒªãƒ³ã‚¿ãƒ¼ã‚¨ãƒ©ãƒ¼0ä»¶

---

## æ¨å®šä½œæ¥­æ™‚é–“

- Phase 6-1: 2-3æ™‚é–“ï¼ˆè¤‡é›‘ãªåˆ†å‰²ï¼‰
- Phase 6-2: 1-2æ™‚é–“
- Phase 6-3: 1æ™‚é–“ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
- **åˆè¨ˆ**: 4-6æ™‚é–“