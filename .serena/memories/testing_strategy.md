# Testing Strategy

このメモリには、OrbitScoreプロジェクトのテスト戦略を記録します。

## テストの種類

### 1. ユニットテスト（自動化）

**対象:**
- パーサー（audio-parser, interpreter-v2）
- タイミング計算（timing-calculator, chop-timing, nested-play-timing）
- オーディオスライサー（audio-slicer）
- シーケンス管理（sequence-gain-pan）
- 数値計算ロジック

**実行環境:**
- ローカル開発環境
- CI環境（GitHub Actions）

**特徴:**
- ✅ 高速実行
- ✅ 自動化可能
- ✅ リグレッション検出に有効

### 2. SuperCollider連携テスト（手動確認）

**対象:**
- `tests/audio/supercollider-gain-pan.spec.ts`
- SuperColliderサーバーとの通信
- 実際の音出し確認

**実行環境:**
- ローカル開発環境のみ（SuperCollider起動が必要）
- **CI環境ではスキップ** (`describe.skipIf(process.env.CI === 'true')`)

**理由:**
- SuperColliderサーバーの起動が必要
- 実際の音出しテストは人間の耳で確認が必要
- CI環境でのセットアップが複雑（Xvfb, ダミーオーディオドライバ等）
- 数値計算のロジックは他のユニットテストでカバー

**実行方法:**
```bash
# ローカル環境でSuperColliderを起動してから
npm test -- tests/audio/supercollider-gain-pan.spec.ts
```

### 3. 音出しテスト（将来実装予定）

**現状:**
- リファクタリングフェーズでは未実装
- 数値計算のテストのみ実施

**将来の計画:**
- リファクタリング完了後に実装
- 実際に音を鳴らして期待通りの音が出ているか確認
- 以下をテスト対象とする予定：
  - 音色の正確性
  - タイミングの精度（実際の再生時間）
  - エフェクトの効果（gain, pan, rate等）
  - スライス再生の正確性
  - ポリリズム・ポリテンポの動作

**実装方法（検討中）:**
- テスト音源を用意
- 期待される波形データと比較
- または、人間による手動確認プロセスを確立

## CI/CD戦略

### GitHub Actions

**実行されるテスト:**
- ✅ パーサーテスト
- ✅ タイミング計算テスト
- ✅ オーディオスライサーテスト
- ✅ シーケンス管理テスト
- ❌ SuperCollider連携テスト（スキップ）

**スキップされるテスト:**
```typescript
describe.skipIf(process.env.CI === 'true')('SuperColliderPlayer - ...', () => {
  // SuperCollider連携テスト
})
```

### ローカル開発

**実行されるテスト:**
- ✅ すべてのユニットテスト
- ✅ SuperCollider連携テスト（SuperCollider起動時）

## テストカバレッジの方針

### 現在のフェーズ（リファクタリング）

**重点:**
- ✅ ロジックの正確性
- ✅ リグレッション防止
- ✅ モジュール分割後の動作確認

**カバー範囲:**
- パーサー: 50 tests
- タイミング: 16 tests
- オーディオ: 9 tests
- シーケンス: 20 tests
- 合計: 100+ tests

### 将来のフェーズ（音出しテスト実装後）

**追加予定:**
- 実際の音出しテスト
- エンドツーエンドテスト
- パフォーマンステスト

## 注意事項

### SuperCollider関連テストについて

1. **CI環境での制約**
   - SuperColliderサーバーの起動が困難
   - オーディオデバイスが必要
   - GUI依存の問題

2. **ローカル環境での実行**
   - SuperColliderをインストール
   - サーバーを起動
   - テストを実行

3. **数値計算のテスト**
   - dB → Amplitude変換
   - Pan値の変換（-100..100 → -1.0..1.0）
   - これらはモックで十分テスト可能

### テスト失敗時の対応

**CI環境でのタイミングテスト失敗:**
- CI環境は処理が遅い場合がある
- タイミング許容範囲を調整（例: 200ms → 300ms）

**SuperCollider連携テスト失敗:**
- ローカル環境でSuperColliderが起動しているか確認
- CI環境では自動的にスキップされる

## まとめ

- **自動化可能なテスト**: CI環境で実行
- **SuperCollider連携テスト**: ローカル環境のみ、手動確認
- **音出しテスト**: 将来実装予定（リファクタリング完了後）
- **テスト戦略**: 段階的に拡充、現在はロジックの正確性を重視