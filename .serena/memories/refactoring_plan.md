# Engine Refactoring Plan

## ç›®çš„
`packages/engine/src`å†…ã®ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„ï¼ˆSRPã€DRYã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«çµ„ç¹”åŒ–ï¼‰ã«å‰‡ã£ã¦ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹ã€‚

## ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ
**æ®µéšçš„ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°**ï¼ˆæ¨å¥¨ï¼‰
- ãƒªã‚¹ã‚¯ãŒä½ã„
- ãƒ†ã‚¹ãƒˆã—ã‚„ã™ã„
- ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã‚„ã™ã„
- ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒå®¹æ˜“
- ä¸¦è¡Œé–‹ç™ºå¯èƒ½

## ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¨å„ªå…ˆåº¦

### ğŸ”´ é«˜å„ªå…ˆåº¦ï¼ˆ500è¡Œä»¥ä¸Šï¼‰
1. ~~**audio-parser.ts** (768è¡Œ)~~ âœ… **å®Œäº†** (PR #21ãƒãƒ¼ã‚¸æ¸ˆã¿)
2. ~~**sequence.ts** (571è¡Œ)~~ âœ… **å®Œäº†** (PR #27ãƒãƒ¼ã‚¸æ¸ˆã¿)
3. ~~**supercollider-player.ts** (506è¡Œ)~~ âœ… **å®Œäº†** (PR #23ãƒãƒ¼ã‚¸æ¸ˆã¿)
4. ~~**global.ts** (432è¡Œ)~~ âœ… **å®Œäº†** (PR #24ãƒãƒ¼ã‚¸æ¸ˆã¿)

### ğŸŸ¡ ä¸­å„ªå…ˆåº¦ï¼ˆ200-500è¡Œï¼‰
5. ~~**audio-engine.ts** (363è¡Œ)~~ âœ… **å®Œäº†** (PR #29ä½œæˆæ¸ˆã¿ã€ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾…ã¡)
6. ~~**cli-audio.ts** (282è¡Œ)~~ âœ… **å®Œäº†** (PR #17ãƒãƒ¼ã‚¸æ¸ˆã¿)
7. ~~**interpreter-v2.ts** (275è¡Œ)~~ âœ… **å®Œäº†** (PR #19ãƒãƒ¼ã‚¸æ¸ˆã¿)

### ğŸŸ¢ ä½å„ªå…ˆåº¦ï¼ˆ200è¡Œæœªæº€ï¼‰
8. **simple-player.ts** (196è¡Œ)
9. **precision-scheduler.ts** (173è¡Œ)
10. ~~**timing-calculator.ts** (151è¡Œ)~~ âœ… **å®Œäº†** (PR #15ãƒãƒ¼ã‚¸æ¸ˆã¿)
11. ~~**audio-slicer.ts** (139è¡Œ)~~ âœ… **å®Œäº†** (PR #13ãƒãƒ¼ã‚¸æ¸ˆã¿)

## å®Ÿæ–½é †åº

### Phase 1: ç¾åœ¨ã®PRã‚’ãƒãƒ¼ã‚¸ âœ… (PR #10ãƒãƒ¼ã‚¸æ¸ˆã¿)

### Phase 2: å°è¦æ¨¡ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰é–‹å§‹
#### 2-1: audio-slicer.ts âœ… **å®Œäº†** (PR #13ãƒãƒ¼ã‚¸æ¸ˆã¿)
#### 2-2: timing-calculator.ts âœ… **å®Œäº†** (PR #15ãƒãƒ¼ã‚¸æ¸ˆã¿)

### Phase 3: ä¸­è¦æ¨¡ãƒ•ã‚¡ã‚¤ãƒ«
#### 3-1: cli-audio.ts âœ… **å®Œäº†** (PR #17ãƒãƒ¼ã‚¸æ¸ˆã¿)
#### 3-2: interpreter-v2.ts âœ… **å®Œäº†** (PR #19ãƒãƒ¼ã‚¸æ¸ˆã¿)

### Phase 4: å¤§è¦æ¨¡ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆæ…é‡ã«ï¼‰

#### 4-1: audio-parser.ts (768è¡Œ) âœ… **å®Œäº†** (PR #21ãƒãƒ¼ã‚¸æ¸ˆã¿)

#### 4-2: supercollider-player.ts (506è¡Œ) âœ… **å®Œäº†** (PR #23ãƒãƒ¼ã‚¸æ¸ˆã¿)

#### 4-3: global.ts (432è¡Œ) âœ… **å®Œäº†** (PR #24ãƒãƒ¼ã‚¸æ¸ˆã¿)

#### 4-4: sequence.ts (571è¡Œ) âœ… **å®Œäº†** (PR #27ãƒãƒ¼ã‚¸æ¸ˆã¿)
- **Issue**: #26
- **Branch**: `26-refactor-sequence-phase-4-4`
- **é–‹å§‹æ—¥**: 2025-01-07
- **å®Œäº†æ—¥**: 2025-01-07
- **ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°çµæœ**:
  - `core/sequence/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æ‹¡å¼µ
  - `types.ts` (132è¡Œ) - å‹å®šç¾©
  - `parameters/gain-manager.ts` (82è¡Œ) - ã‚²ã‚¤ãƒ³ç®¡ç†
  - `parameters/pan-manager.ts` (76è¡Œ) - ãƒ‘ãƒ³ç®¡ç†
  - `parameters/tempo-manager.ts` (103è¡Œ) - ãƒ†ãƒ³ãƒãƒ»æ‹å­ãƒ»é•·ã•ç®¡ç†
  - `parameters/random-utils.ts` (26è¡Œ) - ãƒ©ãƒ³ãƒ€ãƒ å€¤ç”Ÿæˆãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
  - `scheduling/event-scheduler.ts` (183è¡Œ) - ã‚¤ãƒ™ãƒ³ãƒˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°
  - `scheduling/run-scheduler.ts` (64è¡Œ) - ãƒ¯ãƒ³ã‚·ãƒ§ãƒƒãƒˆå†ç”Ÿ
  - `scheduling/loop-scheduler.ts` (85è¡Œ) - ãƒ«ãƒ¼ãƒ—å†ç”Ÿ
  - `state/state-manager.ts` (198è¡Œ) - çŠ¶æ…‹ç®¡ç†
  - `sequence.ts` (ç´„250è¡Œ) - è–„ã„ãƒ©ãƒƒãƒ‘ãƒ¼ï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
- **ãƒã‚°ä¿®æ­£**:
  - ãƒ‘ã‚¹è§£æ±ºã®ä¸ä¸€è‡´ä¿®æ­£ï¼ˆ`scheduleEventsFromTime`ã§`process.cwd()`ãŒæ¬ è½ï¼‰
  - Master Gainæœªé©ç”¨ãƒã‚°ä¿®æ­£ï¼ˆ`finalGainDb = sequenceGainDb + masterGainDb`ï¼‰
  - Pattern Durationå›ºå®šå€¤ãƒã‚°ä¿®æ­£ï¼ˆå‹•çš„è¨ˆç®—ã«å¤‰æ›´ï¼‰
  - Loop Offsetè¨ˆç®—ãƒã‚°ä¿®æ­£ï¼ˆ`loopIteration * patternDuration`ï¼‰
- **ã‚³ãƒ¼ãƒ‰å“è³ªæ”¹å–„**:
  - é‡è¤‡ã‚³ãƒ¼ãƒ‰å‰Šæ¸›: ç´„150è¡Œ
  - æœªä½¿ç”¨ã‚³ãƒ¼ãƒ‰å‰Šé™¤: ç´„50è¡Œï¼ˆ`calculateFinalGain`, `reset`, `getSchedulingState`, etc.ï¼‰
  - å‹å®‰å…¨æ€§å‘ä¸Š: `as any`ã‚­ãƒ£ã‚¹ãƒˆ5ç®‡æ‰€å‰Šé™¤
  - DRYåŸå‰‡å¾¹åº•: `generateRandomValue`, `calculateEventGain`, `seamlessParameterUpdate`ãªã©ã‚’å…±é€šåŒ–
  - Schedulerã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹æ‹¡å¼µ: `startTime`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£è¿½åŠ 
- **ãƒ†ã‚¹ãƒˆ**: âœ… 115 tests passed | 15 skipped
- **ãƒãƒ¼ã‚¸æ—¥**: 2025-01-07

## Phase 5: æ®‹ã‚Šã®ä¸­å„ªå…ˆåº¦ãƒ•ã‚¡ã‚¤ãƒ«

### 5-1: audio-engine.ts (363è¡Œ) - âœ… **å®Œäº†** (PR #29ä½œæˆæ¸ˆã¿ã€ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾…ã¡)
- **Issue**: #28
- **Branch**: `28-refactor-audio-engine-phase-5-1`
- **é–‹å§‹æ—¥**: 2025-01-07
- **å®Œäº†æ—¥**: 2025-01-07
- **ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°çµæœ**:
  - `audio/types.ts` (49è¡Œ) - å‹å®šç¾©
  - `audio/engine/audio-context-manager.ts` (63è¡Œ) - AudioContextç®¡ç†
  - `audio/engine/master-gain-controller.ts` (35è¡Œ) - ãƒã‚¹ã‚¿ãƒ¼ãƒœãƒªãƒ¥ãƒ¼ãƒ åˆ¶å¾¡
  - `audio/engine/audio-file-cache.ts` (81è¡Œ) - ãƒ•ã‚¡ã‚¤ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†
  - `audio/loading/wav-decoder.ts` (78è¡Œ) - WAVãƒ‡ã‚³ãƒ¼ãƒ‰å‡¦ç†
  - `audio/loading/audio-file-loader.ts` (86è¡Œ) - ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ãƒ­ã‚¸ãƒƒã‚¯
  - `audio/slicing/slice-manager.ts` (47è¡Œ) - ã‚¹ãƒ©ã‚¤ã‚¹ä½œæˆãƒ»å–å¾—
  - `audio/playback/slice-player.ts` (54è¡Œ) - å€‹åˆ¥ã‚¹ãƒ©ã‚¤ã‚¹å†ç”Ÿ
  - `audio/playback/sequence-player.ts` (79è¡Œ) - ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å†ç”Ÿ
  - `audio/audio-engine.ts` (ç´„240è¡Œ) - è–„ã„ãƒ©ãƒƒãƒ‘ãƒ¼ï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
- **ã‚³ãƒ¼ãƒ‰å“è³ªæ”¹å–„**:
  - å…¨é–¢æ•°ãŒ50è¡Œä»¥ä¸‹
  - SRPï¼ˆå˜ä¸€è²¬ä»»åŸå‰‡ï¼‰é©ç”¨
  - DRYåŸå‰‡å¾¹åº•
  - æ˜ç¢ºãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 
  - JSDocã‚³ãƒ¡ãƒ³ãƒˆå……å®Ÿ
- **ãƒ†ã‚¹ãƒˆ**: âœ… 115 tests passed | 15 skipped
- **ãƒªãƒ³ã‚¿ãƒ¼ã‚¨ãƒ©ãƒ¼**: âœ… 0ä»¶
- **å¾Œæ–¹äº’æ›æ€§**: å®Œå…¨ã«ç¶­æŒ
- **PR**: #29 (ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾…ã¡)

## Phase 6: ä½å„ªå…ˆåº¦ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆæ®‹ã‚Šï¼‰

### 6-1: simple-player.ts (196è¡Œ) - æ¬¡ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
- SuperColliderãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç°¡æ˜“ç‰ˆ
- ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°æ¨å¥¨

### 6-2: precision-scheduler.ts (173è¡Œ)
- é«˜ç²¾åº¦ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°
- ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°æ¨å¥¨

## å„Phaseã®ä½œæ¥­ãƒ•ãƒ­ãƒ¼

1. **Issueä½œæˆ**: GitHub Issue
2. **ãƒ–ãƒ©ãƒ³ãƒä½œæˆ**: `<issue-number>-<description>`ï¼ˆæ—¥æœ¬èªç¦æ­¢ï¼‰
3. **Serenaãƒ¡ãƒ¢ãƒªæ›´æ–°**: ãƒ–ãƒ©ãƒ³ãƒä½œæˆç›´å¾Œã«`refactoring_plan.md`ã‚’æ›´æ–°ï¼ˆé€²è¡Œä¸­ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼‰
4. **ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å®Ÿæ–½**
5. **PRä½œæˆ**: developãƒ–ãƒ©ãƒ³ãƒã«å¯¾ã—ã¦ã€`Closes #<issue-number>`ã‚’å«ã‚ã‚‹
6. **ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»ãƒãƒ¼ã‚¸**: bugbotãƒ¬ãƒ“ãƒ¥ãƒ¼å¾Œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒãƒ¼ã‚¸
7. **Serenaãƒ¡ãƒ¢ãƒªæ›´æ–°**: ãƒãƒ¼ã‚¸å¾Œã«`refactoring_plan.md`ã‚’æ›´æ–°ï¼ˆå®Œäº†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼‰

## æˆåŠŸåŸºæº–

- âœ… ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒé€šã‚‹
- âœ… å„ãƒ•ã‚¡ã‚¤ãƒ«ãŒ50è¡Œä»¥ä¸‹ã®é–¢æ•°ã§æ§‹æˆã•ã‚Œã‚‹
- âœ… å„é–¢æ•°ãŒå˜ä¸€è²¬ä»»ã‚’æŒã¤
- âœ… é‡è¤‡ã‚³ãƒ¼ãƒ‰ãŒæ’é™¤ã•ã‚Œã‚‹
- âœ… å†åˆ©ç”¨å¯èƒ½ãªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹é€ 
- âœ… æ˜ç¢ºãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 
- âœ… JSDocã‚³ãƒ¡ãƒ³ãƒˆãŒå……å®Ÿ

## ç¾åœ¨ã®çŠ¶æ…‹

- **Phase 5å®Œäº†**: ğŸ‰ å…¨ã¦ã®ä¸­å„ªå…ˆåº¦ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ200-500è¡Œï¼‰ã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å®Œäº†ï¼
- **æ¬¡ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ**: Phase 6-1 (simple-player.ts, 196è¡Œ)